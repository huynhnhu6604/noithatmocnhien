<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Nội thất Mộc Nhiên</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
        
        <!-- Firebase SDK -->
        <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
        
        <!-- Sweetalert2 -->
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

        <!-- Thêm thư viện jsSHA cho SHA512 -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jsSHA/3.2.0/sha512.min.js"></script>

        <!-- VNPAY Libraries -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
        <script src="js/vnpay.js"></script>

        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                font-family: 'Montserrat', sans-serif;
                background-color: #f9f7f3;
            }
            .header-top {
                display: flex;
                align-items: center;
                justify-content: center;
                background-color: #5a3d2b;
                padding: 18px 0 12px 0;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            }
            .logo {
                width: 90px;
                height: 90px;
                margin-right: 18px;
                border-radius: 60%;
                border: 3px solid #e9c46a;
                box-shadow: 0 0 15px rgba(233, 196, 106, 0.6);
                transition: transform 0.3s, box-shadow 0.3s;
                object-fit: cover;
            }
            .logo:hover {
                transform: scale(1.05);
                box-shadow: 0 0 20px rgba(233, 196, 106, 0.8);
            }
            .store-name {
                font-family: 'Great Vibes', cursive;
                font-size: 2.7rem;
                font-weight: 400;
                color: #e9c46a;
                text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
                letter-spacing: 1.5px;
            }
            .header-nav {
                width: 100%;
                background-color: #4a3322;
                box-shadow: 0 2px 8px rgba(0,0,0,0.04);
                display: flex;
                justify-content: center;
            }
            .nav-links {
                display: flex;
                align-items: center;
                gap: 10px;
                flex-wrap: wrap;
                justify-content: center;
                padding: 0 10px;
                min-height: 48px;
            }
            .nav-btn {
                font-family: 'Montserrat', sans-serif;
                text-decoration: none;
                color: #f9f7f3;
                font-weight: 500;
                padding: 8px 12px;
                border-radius: 5px;
                transition: all 0.3s;
                border: 1px solid transparent;
                letter-spacing: 0.5px;
                text-transform: uppercase;
                font-size: 0.75rem;
                position: relative;
                white-space: nowrap;
            }
            .nav-btn:hover {
                background-color: rgba(233, 196, 106, 0.2);
                border-color: #e9c46a;
            }
            .active {
                background-color: rgba(233, 196, 106, 0.2);
                border: 1px solid #e9c46a;
            }
            
            /* Dropdown menu */
            .dropdown {
                position: relative;
            }
            .mega-menu {
                display: none;
                position: absolute;
                left: 0;
                top: 100%;
                background: #fff;
                box-shadow: 0 8px 24px rgba(0,0,0,0.15);
                padding: 24px 32px;
                display: flex;
                gap: 40px;
                z-index: 100;
                min-width: 800px;
                opacity: 0;
                visibility: hidden;
                transform: translateY(10px);
                transition: all 0.3s ease;
            }
            .dropdown:hover .mega-menu {
                display: flex;
                opacity: 1;
                visibility: visible;
                transform: translateY(0);
            }
            .mega-column {
                display: flex;
                flex-direction: column;
                min-width: 160px;
                margin-right: 24px;
            }
            .mega-menu a {
                color: #555;
                padding: 8px 0;
                text-decoration: none;
                font-size: 0.9rem;
                transition: all 0.2s;
                border-bottom: 1px solid transparent;
            }
            .mega-menu a:hover {
                color: #e9c46a;
                border-bottom: 1px solid #e9c46a;
                transform: translateX(5px);
            }
            
            /* Thêm mũi tên cho dropdown */
            .dropdown > .nav-btn::after {
                content: '▼';
                font-size: 0.7em;
                margin-left: 5px;
                display: inline-block;
                transition: transform 0.3s;
            }
            .dropdown:hover > .nav-btn::after {
                transform: rotate(180deg);
            }
            
            /* Nút giỏ hàng */
            .cart-btn {
                display: flex;
                align-items: center;
                gap: 10px;
                color: #d9d1cc;
                padding: 8px 12px;
                border-radius: 5px;
                text-decoration: none;
                transition: all 0.3s;
                font-weight: 600;
                margin-left: 10px;
                font-size: 0.75rem;
            }
            .cart-icon {
                font-size: 2rem;
            }
            .cart-btn:hover {
                background: #d4b054;
                transform: translateY(-2px);
            }
            
            /* Style cho nút đăng nhập */
            .login-btn {
                display: flex;
                align-items: center;
                gap: 6px;
                color: #5a3d2b;
                padding: 8px 16px;
                border-radius: 5px;
                text-decoration: none;
                transition: all 0.3s;
                font-weight: 600;
                margin-left: 10px;
                font-size: 0.75rem;
                background-color: #e9c46a;
                border: 1px solid #e9c46a;
            }
            .login-btn:hover {
                background-color: #5a3d2b;
                color: #e9c46a;
                transform: translateY(-2px);
            }
            main {
                padding: 30px;
                min-height: 600px;
                background-color: #f9f7f3;
            }
            .banner {
                width: 100%;
                max-height: 600px;
                position: relative;
                overflow: hidden;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .banner-image {
                width: 100%;
                height: auto;
                min-height: 400px;
                max-height: 600px;
                object-fit: cover;
                object-position: center;
                transition: transform 10s ease;
                display: block;
                image-rendering: -webkit-optimize-contrast;
                image-rendering: crisp-edges;
                -webkit-image-rendering: crisp-edges;
                backface-visibility: hidden;
            }
            .banner:hover .banner-image {
                transform: scale(1.05);
            }
            .banner-overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.1));
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                color: white;
                padding: 0 20px;
                text-align: center;
            }
            .banner-title {
                font-family: 'Great Vibes', cursive;
                font-size: 4rem;
                margin-bottom: 20px;
                text-shadow: 2px 2px 4px rgba(0,0,0,0.6);
                color: #ffffff;
            }
            .banner-subtitle {
                font-family: 'Montserrat', sans-serif;
                font-size: 1.5rem;
                font-weight: 300;
                max-width: 800px;
                text-shadow: 1px 1px 3px rgba(0,0,0,0.6);
                color: #ffffff;
            }
            /* Phần footer */
            .footer {
                background-color: #5a3d2b;
                color: #e9e2d0;
                padding: 50px 0 20px;
            }
            .footer-container {
                display: flex;
                flex-wrap: wrap;
                justify-content: space-between;
                max-width: 1200px;
                margin: 0 auto;
                padding: 0 20px;
            }
            .footer-section {
                flex: 1;
                min-width: 250px;
                margin-bottom: 30px;
                padding: 0 15px;
            }
            .footer-title {
                font-size: 1.3rem;
                font-weight: 600;
                margin-bottom: 20px;
                color: #e9c46a;
                position: relative;
                padding-bottom: 10px;
            }
            .footer-title::after {
                content: '';
                position: absolute;
                bottom: 0;
                left: 0;
                width: 50px;
                height: 2px;
                background-color: #e9c46a;
            }
            .footer-contact-item {
                display: flex;
                align-items: flex-start;
                margin-bottom: 15px;
            }
            .footer-contact-icon {
                min-width: 20px;
                margin-right: 10px;
                color: #e9c46a;
            }
            .footer-links {
                list-style: none;
            }
            .footer-links li {
                margin-bottom: 10px;
            }
            .footer-links a {
                color: #e9e2d0;
                text-decoration: none;
                transition: color 0.3s;
            }
            .footer-links a:hover {
                color: #e9c46a;
            }
            .footer-bottom {
                text-align: center;
                padding-top: 20px;
                margin-top: 20px;
                border-top: 1px solid rgba(233, 196, 106, 0.2);
                font-size: 0.9rem;
            }

            .posters {
                display: flex;
                gap: 30px;
                justify-content: center;
                align-items: stretch;
                margin: 40px 0 60px 0;
                flex-wrap: wrap;
            }
            .poster {
                background: #fff8ed;
                border-radius: 16px;
                box-shadow: 0 4px 16px rgba(90,61,43,0.08);
                overflow: hidden;
                width: 320px;
                display: flex;
                flex-direction: column;
                transition: transform 0.2s, box-shadow 0.2s;
                border: 1.5px solid #e9c46a;
                cursor: pointer;
            }
            .poster:hover {
                transform: translateY(-6px) scale(1.03);
                box-shadow: 0 8px 32px rgba(90,61,43,0.16);
            }
            .poster-img {
                width: 100%;
                height: 170px;
                object-fit: cover;
                background: #e9e2d0;
            }
            .poster-content {
                padding: 20px 18px 24px 18px;
                flex: 1;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
            }
            .poster-title {
                font-size: 1.25rem;
                color: #5a3d2b;
                margin-bottom: 10px;
                font-weight: 700;
            }
            .poster-desc {
                color: #4a3322;
                font-size: 1rem;
                margin-bottom: 18px;
            }
            .poster-btn {
                display: inline-block;
                background: #e9c46a;
                color: #5a3d2b;
                padding: 8px 20px;
                border-radius: 6px;
                text-decoration: none;
                font-weight: 600;
                letter-spacing: 0.5px;
                transition: background 0.2s, color 0.2s;
            }
            .poster-btn:hover {
                background: #5a3d2b;
                color: #fff8ed;
            }

            /* Styles cho modal */
            .modal-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
                -webkit-backdrop-filter: blur(5px);
                backdrop-filter: blur(5px);
            }

            .modal {
                display: none;
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: #fff8ed;
                padding: 30px;
                border-radius: 12px;
                box-shadow: 0 5px 30px rgba(0, 0, 0, 0.15);
                z-index: 1001;
                width: 90%;
                max-width: 800px;
                max-height: 90vh;
                overflow-y: auto;
            }

            .modal.active {
                display: block;
            }

            .modal-header {
                text-align: center;
                margin-bottom: 25px;
            }

            .modal-title {
                color: #5a3d2b;
                font-size: 1.5rem;
                font-weight: 600;
                margin-bottom: 10px;
            }

            .modal-subtitle {
                color: #4a3322;
                font-size: 0.9rem;
                margin-bottom: 20px;
            }

            .modal-form {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }

            .form-group {
                position: relative;
            }

            .form-input {
                width: 100%;
                padding: 12px 15px;
                border: 1.5px solid #e9c46a;
                border-radius: 8px;
                font-size: 0.9rem;
                color: #5a3d2b;
                background: #fff;
                transition: all 0.3s;
            }

            .form-input:focus {
                outline: none;
                border-color: #5a3d2b;
                box-shadow: 0 0 0 2px rgba(90, 61, 43, 0.1);
            }

            .form-button {
                width: 100%;
                padding: 12px;
                background: #e9c46a;
                color: #5a3d2b;
                border: none;
                border-radius: 8px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
            }

            .form-button:hover:not(:disabled) {
                background: #5a3d2b;
                color: #fff8ed;
            }

            .form-button:disabled {
                opacity: 0.7;
                cursor: not-allowed;
            }

            .modal-links {
                margin-top: 20px;
                text-align: center;
                font-size: 0.9rem;
            }

            .modal-link {
                color: #5a3d2b;
                text-decoration: none;
                cursor: pointer;
                transition: color 0.3s;
            }

            .modal-link:hover {
                color: #e9c46a;
            }

            .spinner {
                width: 20px;
                height: 20px;
                border: 2px solid #5a3d2b;
                border-top: 2px solid transparent;
                border-radius: 50%;
                animation: spin 0.8s linear infinite;
                display: none;
            }

            .form-button:disabled .spinner {
                display: inline-block;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            /* Styles cho các section mới */
            .section-header {
                text-align: center;
                margin-bottom: 40px;
                padding: 0 20px;
            }

            .section-header h2 {
                font-size: 2.5rem;
                color: #5a3d2b;
                margin-bottom: 15px;
                font-weight: 600;
            }

            .section-header p {
                color: #666;
                font-size: 1.1rem;
                max-width: 600px;
                margin: 0 auto;
            }

            /* Featured Products */
            .featured-products {
                padding: 60px 20px;
                background: #fff;
            }

            .product-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 30px;
                max-width: 1200px;
                margin: 0 auto;
            }

            .product-card {
                background: #fff;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 4px 20px rgba(0,0,0,0.08);
                transition: transform 0.3s, box-shadow 0.3s;
                position: relative;
            }

            .product-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            }

            .product-badge {
                position: absolute;
                top: 15px;
                right: 15px;
                background: #e9c46a;
                color: #5a3d2b;
                padding: 5px 12px;
                border-radius: 20px;
                font-size: 0.8rem;
                font-weight: 600;
            }

            .product-image {
                width: 100%;
                height: 250px;
                object-fit: cover;
            }

            .product-info {
                padding: 20px;
            }

            .product-info h3 {
                font-size: 1.2rem;
                color: #5a3d2b;
                margin-bottom: 10px;
            }

            .product-price {
                color: #e9c46a;
                font-size: 1.3rem;
                font-weight: 600;
                margin-bottom: 15px;
            }

            .product-actions {
                display: flex;
                gap: 10px;
            }

            .btn-primary, .btn-secondary {
                padding: 8px 20px;
                border-radius: 6px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
                border: none;
            }

            .btn-primary {
                background: #e9c46a;
                color: #5a3d2b;
            }

            .btn-secondary {
                background: transparent;
                border: 2px solid #e9c46a;
                color: #5a3d2b;
            }

            .btn-primary:hover {
                background: #5a3d2b;
                color: #e9c46a;
            }

            .btn-secondary:hover {
                background: #e9c46a;
            }

            /* Collections */
            .collections {
                padding: 60px 20px;
                background: #f9f7f3;
            }

            .collection-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 30px;
                max-width: 1200px;
                margin: 0 auto;
            }

            .collection-card {
                position: relative;
                border-radius: 12px;
                overflow: hidden;
                height: 400px;
            }

            .collection-image {
                width: 100%;
                height: 100%;
                object-fit: cover;
                transition: transform 0.5s;
            }

            .collection-overlay {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                background: linear-gradient(transparent, rgba(0,0,0,0.7));
                padding: 30px;
                color: white;
                transform: translateY(100px);
                transition: transform 0.3s;
            }

            .collection-card:hover .collection-image {
                transform: scale(1.1);
            }

            .collection-card:hover .collection-overlay {
                transform: translateY(0);
            }

            .collection-overlay h3 {
                font-size: 1.5rem;
                margin-bottom: 10px;
            }

            .btn-outline {
                display: inline-block;
                padding: 8px 20px;
                border: 2px solid white;
                color: white;
                text-decoration: none;
                border-radius: 6px;
                margin-top: 15px;
                transition: all 0.3s;
            }

            .btn-outline:hover {
                background: white;
                color: #5a3d2b;
            }

            /* Services */
            .services {
                padding: 60px 20px;
                background: #fff;
            }

            .service-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 30px;
                max-width: 1200px;
                margin: 0 auto;
            }

            .service-card {
                text-align: center;
                padding: 30px;
                background: #f9f7f3;
                border-radius: 12px;
                transition: transform 0.3s;
            }

            .service-card:hover {
                transform: translateY(-5px);
            }

            .service-icon {
                font-size: 2.5rem;
                margin-bottom: 20px;
            }

            .service-card h3 {
                color: #5a3d2b;
                margin-bottom: 10px;
            }

            .service-card p {
                color: #666;
            }

            /* News */
            .news {
                padding: 60px 20px;
                background: #f9f7f3;
            }

            .news-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 30px;
                max-width: 1200px;
                margin: 0 auto;
            }

            .news-card {
                background: white;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            }

            .news-image {
                width: 100%;
                height: 200px;
                object-fit: cover;
            }

            .news-content {
                padding: 20px;
            }

            .news-date {
                color: #666;
                font-size: 0.9rem;
            }

            .news-content h3 {
                color: #5a3d2b;
                margin: 10px 0;
                font-size: 1.2rem;
            }

            .read-more {
                display: inline-block;
                color: #e9c46a;
                text-decoration: none;
                margin-top: 15px;
                font-weight: 600;
            }

            /* Testimonials */
            .testimonials {
                padding: 60px 20px;
                background: #fff;
            }

            .testimonial-slider {
                max-width: 800px;
                margin: 0 auto;
            }

            .testimonial-card {
                background: #f9f7f3;
                padding: 30px;
                border-radius: 12px;
                margin: 20px;
            }

            .testimonial-content {
                font-style: italic;
                color: #666;
                margin-bottom: 20px;
            }

            .testimonial-author {
                display: flex;
                align-items: center;
                gap: 15px;
            }

            .author-image {
                width: 60px;
                height: 60px;
                border-radius: 50%;
                object-fit: cover;
            }

            .author-info h4 {
                color: #5a3d2b;
                margin-bottom: 5px;
            }

            .author-info p {
                color: #666;
                font-size: 0.9rem;
            }

            /* Contact */
            .contact {
                padding: 80px 20px;
                background-color: #f9f7f3;
            }

            .contact-header {
                text-align: center;
                margin-bottom: 50px;
            }

            .contact-header h2 {
                font-size: 2.5rem;
                color: #5a3d2b;
                margin-bottom: 15px;
            }

            .contact-header p {
                color: #666;
                font-size: 1.1rem;
            }

            .contact-container {
                max-width: 1200px;
                margin: 0 auto;
                display: grid;
                grid-template-columns: 1fr 2fr;
                gap: 50px;
            }

            .contact-info {
                background: white;
                padding: 30px;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            }

            .info-item {
                display: flex;
                align-items: flex-start;
                gap: 15px;
                margin-bottom: 25px;
            }

            .info-item:last-child {
                margin-bottom: 0;
            }

            .info-item i {
                font-size: 1.5rem;
                color: #e9c46a;
                margin-top: 5px;
            }

            .info-item h3 {
                font-size: 1.2rem;
                color: #5a3d2b;
                margin-bottom: 5px;
            }

            .info-item p {
                color: #666;
                line-height: 1.5;
            }

            .contact-form {
                background: white;
                padding: 30px;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            }

            .form-group {
                margin-bottom: 20px;
            }

            .form-group label {
                display: block;
                margin-bottom: 8px;
                color: #5a3d2b;
                font-weight: 500;
            }

            .form-control {
                width: 100%;
                padding: 12px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 1rem;
            }

            .form-control:focus {
                outline: none;
                border-color: #e9c46a;
                box-shadow: 0 0 0 3px rgba(233, 196, 106, 0.2);
            }

            textarea.form-control {
                resize: vertical;
                min-height: 120px;
            }

            .btn {
                padding: 12px 24px;
                border: none;
                border-radius: 6px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
                font-size: 1rem;
            }

            .btn-primary {
                background: #e9c46a;
                color: #5a3d2b;
            }

            .btn-primary:hover {
                background: #5a3d2b;
                color: #e9c46a;
            }

            @media (max-width: 768px) {
                .contact-container {
                    grid-template-columns: 1fr;
                }
                
                .contact-header h2 {
                    font-size: 2rem;
                }
            }

            /* Cart Styles */
            .cart-container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 40px 20px;
            }

            .cart-title {
                font-size: 2rem;
                color: #5a3d2b;
                margin-bottom: 30px;
                text-align: center;
                font-family: 'Great Vibes', cursive;
            }

            .cart-content {
                display: grid;
                grid-template-columns: 2fr 1fr;
                gap: 30px;
            }

            .cart-items {
                background: white;
                border-radius: 12px;
                padding: 20px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            }

            .cart-item {
                display: grid;
                grid-template-columns: 100px 2fr 1fr 1fr auto;
                gap: 20px;
                align-items: center;
                padding: 20px 0;
                border-bottom: 1px solid #eee;
                transition: all 0.3s ease;
            }

            .cart-item:hover {
                background: #f9f7f3;
            }

            .cart-item:last-child {
                border-bottom: none;
            }

            .cart-item-image {
                width: 100px;
                height: 100px;
                object-fit: cover;
                border-radius: 8px;
                transition: transform 0.3s ease;
            }

            .cart-item-image:hover {
                transform: scale(1.05);
            }

            .cart-item-details h3 {
                color: #5a3d2b;
                margin-bottom: 8px;
                font-size: 1.1rem;
            }

            .cart-item-details p {
                color: #666;
                font-size: 0.9rem;
            }

            .cart-item-price {
                color: #e9c46a;
                font-weight: 600;
                font-size: 1.2rem;
            }

            .cart-item-price .original-price {
                text-decoration: line-through;
                color: #999;
                font-size: 0.9rem;
                margin-right: 8px;
            }

            .quantity-controls {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .quantity-btn {
                background: #f9f7f3;
                border: 1px solid #e9c46a;
                color: #5a3d2b;
                width: 30px;
                height: 30px;
                border-radius: 4px;
                cursor: pointer;
                transition: all 0.3s;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .quantity-btn:hover {
                background: #e9c46a;
                color: white;
            }

            .quantity-input {
                width: 50px;
                text-align: center;
                border: 1px solid #ddd;
                border-radius: 4px;
                padding: 5px;
                font-size: 0.9rem;
            }

            .remove-btn {
                color: #ff6b6b;
                background: none;
                border: none;
                cursor: pointer;
                font-size: 1.2rem;
                transition: all 0.3s;
                padding: 5px;
            }

            .remove-btn:hover {
                color: #ff0000;
                transform: scale(1.1);
            }

            .cart-summary {
                background: #fff;
                padding: 25px;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            }

            .summary-row {
                display: flex;
                justify-content: space-between;
                margin-bottom: 15px;
                font-size: 1.1rem;
                color: #666;
            }

            .summary-row.total {
                font-size: 1.3rem;
                font-weight: 600;
                color: #5a3d2b;
                border-top: 2px solid #eee;
                padding-top: 15px;
                margin-top: 15px;
            }

            .promo-code {
                margin: 20px 0;
                padding: 15px;
                background: #f9f7f3;
                border-radius: 8px;
            }

            .promo-code h4 {
                color: #5a3d2b;
                margin-bottom: 10px;
                font-size: 1rem;
            }

            .promo-input {
                display: flex;
                gap: 10px;
            }

            .promo-input input {
                flex: 1;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 0.9rem;
            }

            .apply-btn {
                padding: 10px 15px;
                background: #e9c46a;
                color: #5a3d2b;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                transition: all 0.3s;
                font-weight: 600;
            }

            .apply-btn:hover {
                background: #5a3d2b;
                color: #e9c46a;
            }

            .shipping-options {
                margin: 20px 0;
                padding: 15px;
                background: #f9f7f3;
                border-radius: 8px;
            }

            .shipping-options h4 {
                color: #5a3d2b;
                margin-bottom: 10px;
                font-size: 1rem;
            }

            .shipping-option {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 10px;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                cursor: pointer;
                transition: all 0.3s;
            }

            .shipping-option:hover {
                border-color: #e9c46a;
            }

            .shipping-option.selected {
                border-color: #e9c46a;
                background: rgba(233, 196, 106, 0.1);
            }

            .payment-methods {
                margin: 20px 0;
                padding: 15px;
                background: #f9f7f3;
                border-radius: 8px;
            }

            .payment-methods h4 {
                color: #5a3d2b;
                margin-bottom: 10px;
                font-size: 1rem;
            }

            .vnpay-info {
                display: flex;
                align-items: center;
                gap: 15px;
                padding: 15px;
                background: white;
                border: 1px solid #e9c46a;
                border-radius: 8px;
                margin-bottom: 15px;
            }

            .vnpay-logo {
                width: 60px;
                height: 60px;
                object-fit: contain;
            }

            .vnpay-details {
                flex: 1;
            }

            .vnpay-details h5 {
                color: #5a3d2b;
                margin-bottom: 5px;
                font-size: 1rem;
            }

            .vnpay-details p {
                color: #666;
                font-size: 0.9rem;
                margin: 0;
            }

            .bank-list {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
                margin-top: 15px;
            }

            .bank-item {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
                cursor: pointer;
                transition: all 0.3s;
            }

            .bank-item:hover {
                border-color: #e9c46a;
                background: rgba(233, 196, 106, 0.1);
            }

            .bank-item.selected {
                border-color: #e9c46a;
                background: rgba(233, 196, 106, 0.1);
            }

            .bank-logo {
                width: 30px;
                height: 30px;
                object-fit: contain;
            }

            .bank-name {
                font-size: 0.9rem;
                color: #5a3d2b;
            }

            @media (max-width: 768px) {
                .bank-list {
                    grid-template-columns: repeat(2, 1fr);
                }
            }

            .checkout-btn {
                display: block;
                width: 100%;
                padding: 15px;
                background: #e9c46a;
                color: #5a3d2b;
                border: none;
                border-radius: 8px;
                font-size: 1.1rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
                margin-top: 20px;
                position: relative;
                overflow: hidden;
            }

            .checkout-btn:hover {
                background: #5a3d2b;
                color: #e9c46a;
                transform: translateY(-2px);
            }

            .checkout-btn::after {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 5px;
                height: 5px;
                background: rgba(255, 255, 255, 0.5);
                opacity: 0;
                border-radius: 100%;
                transform: scale(1, 1) translate(-50%);
                transform-origin: 50% 50%;
            }

            .checkout-btn:hover::after {
                animation: ripple 1s ease-out;
            }

            @keyframes ripple {
                0% {
                    transform: scale(0, 0);
                    opacity: 0.5;
                }
                100% {
                    transform: scale(20, 20);
                    opacity: 0;
                }
            }

            .empty-cart {
                text-align: center;
                padding: 50px 20px;
            }

            .empty-cart h2 {
                color: #5a3d2b;
                margin-bottom: 20px;
                font-size: 1.5rem;
            }

            .empty-cart p {
                color: #666;
                margin-bottom: 30px;
            }

            .continue-shopping {
                display: inline-block;
                padding: 12px 24px;
                background: #e9c46a;
                color: #5a3d2b;
                text-decoration: none;
                border-radius: 8px;
                font-weight: 600;
                transition: all 0.3s;
            }

            .continue-shopping:hover {
                background: #5a3d2b;
                color: #e9c46a;
                transform: translateY(-2px);
            }

            .cart-features {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 20px;
                margin-top: 30px;
            }

            .feature-item {
                background: white;
                padding: 20px;
                border-radius: 8px;
                text-align: center;
                box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            }

            .feature-icon {
                font-size: 2rem;
                color: #e9c46a;
                margin-bottom: 10px;
            }

            .feature-title {
                color: #5a3d2b;
                font-size: 1.1rem;
                margin-bottom: 5px;
            }

            .feature-desc {
                color: #666;
                font-size: 0.9rem;
            }

            @media (max-width: 768px) {
                .cart-content {
                    grid-template-columns: 1fr;
                }

                .cart-item {
                    grid-template-columns: 80px 1fr;
                    gap: 10px;
                }

                .cart-item-price, .quantity-controls {
                    grid-column: 2;
                }

                .cart-features {
                    grid-template-columns: 1fr;
                }
            }

            /* Style cho modal thanh toán */
            .payment-method {
                margin: 20px 0;
                padding: 20px;
                background: #f9f7f3;
                border-radius: 12px;
            }

            .payment-method h3 {
                color: #5a3d2b;
                margin-bottom: 15px;
                font-size: 1.2rem;
            }

            .payment-options {
                display: flex;
                gap: 15px;
            }

            .payment-option {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 10px 15px;
                border: 2px solid #e9c46a;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.3s;
            }

            .payment-option:hover {
                background: #e9c46a;
                color: #5a3d2b;
            }

            .payment-option input[type="radio"] {
                display: none;
            }

            .payment-option input[type="radio"]:checked + .payment-icon + .payment-text {
                color: #5a3d2b;
                font-weight: 600;
            }

            .payment-icon {
                font-size: 1.5rem;
            }

            .order-summary {
                margin: 20px 0;
                padding: 20px;
                background: #f9f7f3;
                border-radius: 12px;
            }

            .order-summary h3 {
                color: #5a3d2b;
                margin-bottom: 15px;
                font-size: 1.2rem;
            }

            .summary-row {
                display: flex;
                justify-content: space-between;
                margin-bottom: 10px;
                color: #666;
            }

            .summary-row.total {
                margin-top: 15px;
                padding-top: 15px;
                border-top: 1px solid #ddd;
                font-weight: 600;
                color: #5a3d2b;
                font-size: 1.2rem;
            }

            .payment-button {
                width: 100%;
                padding: 15px;
                background: #e9c46a;
                color: #5a3d2b;
                border: none;
                border-radius: 8px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
            }

            .payment-button:hover {
                background: #5a3d2b;
                color: #e9c46a;
            }

            .payment-button:disabled {
                opacity: 0.7;
                cursor: not-allowed;
            }

            .form-group {
                margin-bottom: 15px;
            }

            .form-group label {
                display: block;
                margin-bottom: 5px;
                color: #5a3d2b;
                font-weight: 500;
            }

            .form-input {
                width: 100%;
                padding: 12px;
                border: 1.5px solid #e9c46a;
                border-radius: 8px;
                font-size: 0.9rem;
                color: #5a3d2b;
                background: #fff;
                transition: all 0.3s;
            }

            .form-input:focus {
                outline: none;
                border-color: #5a3d2b;
                box-shadow: 0 0 0 2px rgba(90, 61, 43, 0.1);
            }

            /* Styles cho modal thanh toán */
            .payment-steps {
                display: flex;
                justify-content: space-between;
                margin-bottom: 20px;
                padding: 0 10px;
                border-bottom: 1px solid #e9c46a;
                padding-bottom: 10px;
            }

            .step {
                font-size: 0.9rem;
                color: #5a3d2b;
                font-weight: 500;
            }

            .step.active {
                color: #e9c46a;
                font-weight: 600;
            }

            /* Xóa các style không cần thiết */
            .step-number, .step-text, .step:not(:last-child)::after {
                display: none;
            }

            .form-section {
                background: #fff;
                border-radius: 12px;
                padding: 20px;
                margin-bottom: 20px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            }

            .form-section h3 {
                color: #5a3d2b;
                margin-bottom: 20px;
                font-size: 1.2rem;
            }

            .form-group {
                margin-bottom: 15px;
            }

            .form-group label {
                display: block;
                margin-bottom: 8px;
                color: #5a3d2b;
                font-weight: 500;
            }

            .form-input {
                width: 100%;
                padding: 12px;
                border: 1.5px solid #e9c46a;
                border-radius: 8px;
                font-size: 0.9rem;
                color: #5a3d2b;
                background: #fff;
                transition: all 0.3s;
            }

            .form-input:focus {
                outline: none;
                border-color: #5a3d2b;
                box-shadow: 0 0 0 2px rgba(90, 61, 43, 0.1);
            }

            .order-items {
                margin-bottom: 20px;
            }

            .order-item {
                display: flex;
                align-items: center;
                padding: 10px 0;
                border-bottom: 1px solid #eee;
            }

            .order-item-image {
                width: 60px;
                height: 60px;
                object-fit: cover;
                border-radius: 8px;
                margin-right: 15px;
            }

            .order-item-details {
                flex: 1;
            }

            .order-item-name {
                font-weight: 600;
                color: #5a3d2b;
                margin-bottom: 5px;
            }

            .order-item-price {
                color: #e9c46a;
                font-weight: 600;
            }

            .payment-methods {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }

            .payment-method {
                position: relative;
            }

            .payment-method input[type="radio"] {
                position: absolute;
                opacity: 0;
            }

            .payment-method-label {
                display: flex;
                align-items: center;
                padding: 15px;
                border: 2px solid #e9c46a;
                border-radius: 12px;
                cursor: pointer;
                transition: all 0.3s;
            }

            .payment-method input[type="radio"]:checked + .payment-method-label {
                background: rgba(233, 196, 106, 0.1);
            }

            .payment-logo {
                width: 50px;
                height: 50px;
                object-fit: contain;
                margin-right: 15px;
            }

            .payment-info h4 {
                color: #5a3d2b;
                margin-bottom: 5px;
            }

            .payment-info p {
                color: #666;
                font-size: 0.9rem;
            }

            .form-actions {
                display: flex;
                justify-content: flex-end;
                gap: 15px;
                margin-top: 30px;
            }

            .btn-primary, .btn-secondary {
                padding: 12px 24px;
                border-radius: 8px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
            }

            .btn-primary {
                background: #e9c46a;
                color: #5a3d2b;
                border: none;
            }

            .btn-secondary {
                background: transparent;
                border: 2px solid #e9c46a;
                color: #5a3d2b;
            }

            .btn-primary:hover {
                background: #5a3d2b;
                color: #e9c46a;
            }

            .btn-secondary:hover {
                background: #e9c46a;
                color: #5a3d2b;
            }

            .confirmation-section {
                margin-bottom: 20px;
            }

            .confirmation-section h4 {
                color: #5a3d2b;
                margin-bottom: 10px;
                font-size: 1.1rem;
            }

            .confirmation-info {
                background: #f9f7f3;
                padding: 15px;
                border-radius: 8px;
            }

            .promo-code-section {
                margin-bottom: 25px;
                padding-bottom: 20px;
                border-bottom: 1px solid #eee;
            }

            .promo-code-section h3 {
                color: #5a3d2b;
                font-size: 1.2rem;
                margin-bottom: 15px;
            }

            .promo-code-input {
                display: flex;
                gap: 10px;
                margin-bottom: 10px;
            }

            .promo-code-input input {
                flex: 1;
                padding: 12px 15px;
                border: 1.5px solid #e9c46a;
                border-radius: 8px;
                font-size: 0.9rem;
                color: #5a3d2b;
                transition: all 0.3s;
            }

            .promo-code-input input:focus {
                outline: none;
                border-color: #5a3d2b;
                box-shadow: 0 0 0 2px rgba(90, 61, 43, 0.1);
            }

            .promo-code-input button {
                padding: 12px 20px;
                background: #e9c46a;
                color: #5a3d2b;
                border: none;
                border-radius: 8px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
            }

            .promo-code-input button:hover {
                background: #5a3d2b;
                color: #e9c46a;
            }

            .promo-code-message {
                font-size: 0.9rem;
                margin-top: 10px;
            }

            .promo-code-message.success {
                color: #28a745;
            }

            .promo-code-message.error {
                color: #dc3545;
            }

            .active-promo {
                margin-top: 15px;
                padding: 15px;
                background: #f9f7f3;
                border-radius: 8px;
                display: none;
            }

            .active-promo.show {
                display: block;
            }

            .active-promo .promo-title {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 10px;
            }

            .active-promo .promo-title .icon {
                font-size: 1.5rem;
            }

            .active-promo .promo-title h4 {
                color: #5a3d2b;
                margin: 0;
            }

            .active-promo .promo-description {
                color: #666;
                font-size: 0.9rem;
                margin-bottom: 10px;
            }

            .active-promo .promo-amount {
                color: #e9c46a;
                font-weight: 600;
                font-size: 1.1rem;
            }

            .active-promo .remove-promo {
                color: #dc3545;
                background: none;
                border: none;
                padding: 5px 10px;
                cursor: pointer;
                font-size: 0.9rem;
                margin-top: 10px;
            }

            .active-promo .remove-promo:hover {
                text-decoration: underline;
            }
        </style>
    </head>
    <body>
        <div class="header-top">
            <img src="picture/logo.jpg" alt="Mộc Nhiên Logo" class="logo">
            <div class="store-name">Nội thất Mộc Nhiên</div>
        </div>
        <nav class="header-nav">
            <div class="nav-links">
                <a href="index.html" class="nav-btn active">Trang chủ</a>
                <div class="dropdown">
                    <a href="products.html" class="nav-btn">Sản phẩm</a>
                    <div class="mega-menu">
                        <div class="mega-column">
                            <a href="products.html?category=Sofa">Sofa</a>
                            <a href="products.html?category=Ghế dài & đôn">Ghế dài & đôn</a>
                            <a href="products.html?category=Bàn nước">Bàn nước</a>
                            <a href="products.html?category=Tủ tivi">Tủ tivi</a>
                            <a href="products.html?category=Kệ trưng bày">Kệ trưng bày</a>
                            <a href="products.html?category=Tủ giày">Tủ giày</a>
                        </div>
                        <div class="mega-column">
                            <a href="products.html?category=Bàn ăn">Bàn ăn</a>
                            <a href="products.html?category=Ghế ăn">Ghế ăn</a>
                            <a href="products.html?category=Ghế Bar">Ghế Bar</a>
                            <a href="products.html?category=Tủ ly">Tủ ly</a>
                            <a href="products.html?category=Tủ bếp">Tủ bếp</a>
                        </div>
                        <div class="mega-column">
                            <a href="products.html?category=Giường ngủ">Giường ngủ</a>
                            <a href="products.html?category=Bàn đầu giường">Bàn đầu giường</a>
                            <a href="products.html?category=Bàn trang điểm">Bàn trang điểm</a>
                            <a href="products.html?category=Tủ áo">Tủ áo</a>
                            <a href="products.html?category=Nệm">Nệm</a>
                        </div>
                        <div class="mega-column">
                            <a href="products.html?category=Bàn làm việc">Bàn làm việc</a>
                            <a href="products.html?category=Ghế làm việc">Ghế làm việc</a>
                            <a href="products.html?category=Kệ sách">Kệ sách</a>
                            <a href="products.html?category=Bàn ngoài trời">Bàn ngoài trời</a>
                            <a href="products.html?category=Ghế ngoài trời">Ghế ngoài trời</a>
                        </div>
                        <div class="mega-column">
                            <a href="products.html?category=Đèn trang trí">Đèn trang trí</a>
                            <a href="products.html?category=Thảm trang trí">Thảm trang trí</a>
                            <a href="products.html?category=Bình trang trí">Bình trang trí</a>
                            <a href="products.html?category=Tranh">Tranh</a>
                            <a href="products.html?category=Gương">Gương</a>
                            <a href="products.html?category=Đồng hồ">Đồng hồ</a>
                            <a href="products.html?category=Tượng trang trí">Tượng trang trí</a>
                            <a href="products.html?category=Dụng cụ bếp">Dụng cụ bếp</a>
                        </div>
                    </div>
                </div>
                <a href="collection.html" class="nav-btn">Bộ sưu tập</a>
                <a href="promotion.html" class="nav-btn">Khuyến mãi</a>
                <a href="member.html" class="nav-btn">Thành viên</a>
                <a href="policy.html" class="nav-btn">Chính sách</a>
                <a href="about.html" class="nav-btn">Về chúng tôi</a>
                <a href="cart.html" class="cart-btn">
                    <span class="cart-icon">🛒</span>
                    <span>Giỏ hàng</span>
                </a>
                <a href="#" class="login-btn" onclick="showModal('loginModal')">
                    <span>👤</span>
                    <span>Đăng nhập</span>
                </a>
            </div>
        </nav>
        <main>
            <div class="cart-container">
                <h2 class="cart-title">Giỏ hàng của bạn</h2>
                <div class="cart-content">
                    <div class="cart-items">
                        <div id="cart-items">
                            <!-- Cart items will be dynamically added here -->
                        </div>
                    </div>
                    <div class="cart-summary">
                        <div class="promo-code-section">
                            <h3>Mã giảm giá</h3>
                            <div class="promo-code-input">
                                <input type="text" id="promoCode" placeholder="Nhập mã giảm giá">
                                <button onclick="applyPromoCode()">Áp dụng</button>
                            </div>
                            <div id="promoCodeMessage" class="promo-code-message"></div>
                            <div id="activePromo" class="active-promo"></div>
                        </div>
                        <div class="summary-row">
                            <span>Tạm tính:</span>
                            <span id="subtotal">0 đ</span>
                        </div>
                        <div class="summary-row">
                            <span>Phí vận chuyển:</span>
                            <span id="shipping">0 đ</span>
                        </div>
                        <div class="summary-row">
                            <span>Giảm giá:</span>
                            <span id="discount">0 đ</span>
                        </div>
                        <div class="summary-row total">
                            <span>Tổng cộng:</span>
                            <span id="total">0 đ</span>
                        </div>
                        <button id="checkout-btn" class="checkout-btn">Thanh toán</button>
                    </div>
                </div>
                <div class="cart-features">
                    <div class="feature-item">
                        <div class="feature-icon">🚚</div>
                        <h3 class="feature-title">Miễn phí vận chuyển</h3>
                        <p class="feature-desc">Cho đơn hàng trên 1 triệu đồng</p>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">🔄</div>
                        <h3 class="feature-title">Đổi trả dễ dàng</h3>
                        <p class="feature-desc">30 ngày đổi trả miễn phí</p>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">🔒</div>
                        <h3 class="feature-title">Thanh toán an toàn</h3>
                        <p class="feature-desc">Bảo mật thông tin thanh toán</p>
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="footer">
            <div class="footer-container">
                <div class="footer-section">
                    <h3 class="footer-title">Về Mộc Nhiên</h3>
                    <p>Với nhiểu năm nghiên cứu về các sản phẩm nội thất, Mộc Nhiên tự hào mang đến những sản phẩm nội thất gỗ tự nhiên chất lượng cao, thiết kế độc đáo và tinh tế.</p>
                </div>
                
                <div class="footer-section">
                    <h3 class="footer-title">Liên hệ</h3>
                    <div class="footer-contact-item">
                        <span class="footer-contact-icon">📍</span>
                        <span>Nguyễn Văn Cừ, An Khánh, Ninh Kiều, Cần Thơ </span>
                    </div>
                    <div class="footer-contact-item">
                        <span class="footer-contact-icon">📱</span>
                        <span>0123456789</span>
                    </div>
                    <div class="footer-contact-item">
                        <span class="footer-contact-icon">✉️</span>
                        <span>noithatmocnhien@gmail.com</span>
                    </div>
                </div>
                
                <div class="footer-section">
                    <h3 class="footer-title">Danh mục</h3>  
                    <ul class="footer-links">
                        <li><a href="#">Phòng khách</a></li>
                        <li><a href="#">Phòng ngủ</a></li>
                        <li><a href="#">Phòng bếp</a></li>
                        <li><a href="#">Phòng làm việc</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h3 class="footer-title">Theo dõi</h3>
                    <ul class="footer-links">
                        <li><a href="#">Facebook</a></li>
                        <li><a href="#">Instagram</a></li>
                        <li><a href="#">Email</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2025 Nội thất Mộc Nhiên. Tất cả quyền được bảo lưu.</p>
            </div>
        </footer>

        <!-- Modal Overlay -->
        <div class="modal-overlay" id="modalOverlay"></div>

        <!-- Modal Đăng nhập -->
        <div class="modal" id="loginModal">
            <div class="modal-header">
                <h2 class="modal-title">Đăng nhập</h2>
                <p class="modal-subtitle">Đăng nhập để trải nghiệm dịch vụ tốt nhất từ Mộc Nhiên</p>
            </div>
            <form class="modal-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <input type="email" class="form-input" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" class="form-input" placeholder="Mật khẩu" required>
                </div>
                <button type="submit" class="form-button">
                    <span>Đăng nhập</span>
                    <div class="spinner"></div>
                </button>
            </form>
            <div class="modal-links">
                <a class="modal-link" onclick="showModal('registerModal')">Đăng ký tài khoản mới</a>
                <br>
                <a class="modal-link" onclick="showModal('forgotModal')">Quên mật khẩu?</a>
            </div>
        </div>

        <!-- Modal Đăng ký -->
        <div class="modal" id="registerModal">
            <div class="modal-header">
                <h2 class="modal-title">Đăng ký</h2>
                <p class="modal-subtitle">Tạo tài khoản để nhận nhiều ưu đãi từ Mộc Nhiên</p>
            </div>
            <form class="modal-form" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <input type="text" class="form-input" placeholder="Họ và tên" required>
                </div>
                <div class="form-group">
                    <input type="email" class="form-input" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" class="form-input" placeholder="Mật khẩu" required>
                </div>
                <div class="form-group">
                    <input type="password" class="form-input" placeholder="Xác nhận mật khẩu" required>
                </div>
                <button type="submit" class="form-button">
                    <span>Đăng ký</span>
                    <div class="spinner"></div>
                </button>
            </form>
            <div class="modal-links">
                <a class="modal-link" onclick="showModal('loginModal')">Đã có tài khoản? Đăng nhập</a>
            </div>
        </div>

        <!-- Modal Quên mật khẩu -->
        <div class="modal" id="forgotModal">
            <div class="modal-header">
                <h2 class="modal-title">Quên mật khẩu</h2>
                <p class="modal-subtitle">Nhập email để nhận link đặt lại mật khẩu</p>
            </div>
            <form class="modal-form" onsubmit="handleForgotPassword(event)">
                <div class="form-group">
                    <input type="email" class="form-input" placeholder="Email" required>
                </div>
                <button type="submit" class="form-button">
                    <span>Gửi yêu cầu</span>
                    <div class="spinner"></div>
                </button>
            </form>
            <div class="modal-links">
                <a class="modal-link" onclick="showModal('loginModal')">Quay lại đăng nhập</a>
            </div>
        </div>

        <!-- Modal Thanh toán -->   
        <div class="modal" id="paymentModal">
            <div class="modal-header">
                <h2 class="modal-title">Thanh toán</h2>
            </div>
            <div class="modal-content">
                <div class="payment-steps">
                    <div class="step active" data-step="1">1. Thông tin giao hàng</div>
                    <div class="step" data-step="2">2. Phương thức thanh toán</div>
                    <div class="step" data-step="3">3. Xác nhận đơn hàng</div>
                </div>

                <form id="paymentForm" onsubmit="handlePayment(event)">
                    <div class="step-content" id="step1">
                        <div class="form-section">
                            <h3>Thông tin người nhận</h3>
                            <div class="form-group">
                                <label for="fullName">Họ và tên *</label>
                                <input type="text" id="fullName" name="fullName" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label for="phone">Số điện thoại *</label>
                                <input type="tel" id="phone" name="phone" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label for="email">Email *</label>
                                <input type="email" id="email" name="email" class="form-input" required>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3>Địa chỉ giao hàng</h3>
                            <div class="form-group">
                                <label for="address">Địa chỉ chi tiết *</label>
                                <textarea id="address" name="address" class="form-input" rows="3" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="note">Ghi chú</label>
                                <textarea id="note" name="note" class="form-input" rows="2" placeholder="Ghi chú về đơn hàng, ví dụ: thời gian hay chỉ dẫn địa điểm giao hàng chi tiết hơn."></textarea>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3>Tổng quan đơn hàng</h3>
                            <div class="order-items">
                                <!-- Sản phẩm sẽ được thêm vào đây bằng JavaScript -->
                            </div>
                            <div class="order-summary">
                                <div class="summary-row">
                                    <span>Tạm tính:</span>
                                    <span id="subtotalAmount"></span>
                                </div>
                                <div class="summary-row">
                                    <span>Phí vận chuyển:</span>
                                    <span id="shippingAmount"></span>
                                </div>
                                <div class="summary-row total">
                                    <span>Tổng cộng:</span>
                                    <span id="totalAmount"></span>
                                </div>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn-secondary" onclick="closeModal('paymentModal')">Hủy</button>
                            <button type="button" class="btn-primary" onclick="nextStep(1)">Tiếp tục</button>
                        </div>
                    </div>

                    <div class="step-content" id="step2" style="display: none;">
                        <div class="form-section">
                            <h3>Chọn phương thức thanh toán</h3>
                            <div class="payment-methods">
                                <div class="payment-method">
                                    <input type="radio" name="paymentMethod" id="vnpay" value="vnpay" checked>
                                    <label for="vnpay" class="payment-method-label">
                                        <img src="https://cdn.haitrieu.com/wp-content/uploads/2022/10/Icon-VNPAY-QR.png" alt="VNPay" class="payment-logo">
                                        <div class="payment-info">
                                            <h4>VNPay</h4>
                                            <p>Thanh toán qua VNPay - An toàn, nhanh chóng</p>
                                        </div>
                                    </label>
                                </div>

                                <div class="payment-method">
                                    <input type="radio" name="paymentMethod" id="cod" value="cod">
                                    <label for="cod" class="payment-method-label">
                                        <img src="https://baobihuuco.com/wp-content/uploads/2019/04/icon-giao-hang-toan-quoc.jpg" alt="COD" class="payment-logo">
                                        <div class="payment-info">
                                            <h4>Thanh toán khi nhận hàng (COD)</h4>
                                            <p>Thanh toán bằng tiền mặt khi nhận hàng</p>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn-secondary" onclick="prevStep(2)">Quay lại</button>
                            <button type="button" class="btn-primary" onclick="nextStep(2)">Tiếp tục</button>
                        </div>
                    </div>

                    <div class="step-content" id="step3" style="display: none;">
                        <div class="form-section">
                            <h3>Xác nhận đơn hàng</h3>
                            <div class="order-confirmation">
                                <div class="confirmation-section">
                                    <h4>Thông tin người nhận</h4>
                                    <div id="confirmDeliveryInfo"></div>
                                </div>
                                <div class="confirmation-section">
                                    <h4>Phương thức thanh toán</h4>
                                    <div id="confirmPaymentMethod"></div>
                                </div>
                                <div class="confirmation-section">
                                    <h4>Chi tiết đơn hàng</h4>
                                    <div id="confirmOrderItems"></div>
                                </div>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn-secondary" onclick="prevStep(3)">Quay lại</button>
                            <button type="button" class="btn-primary" onclick="submitOrder()">Đặt hàng</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <script>
            // Hàm hiển thị thông báo lỗi
            function showError(title, message) {
                Swal.fire({
                    icon: 'error',
                    title: title,
                    text: message,
                    confirmButtonColor: '#5a3d2b',
                });
            }

            // Hàm hiển thị thông báo thành công
            function showSuccess(title, message) {
                Swal.fire({
                    icon: 'success',
                    title: title,
                    text: message,
                    confirmButtonColor: '#5a3d2b',
                });
            }

            // Hàm hiển thị xác nhận
            function showConfirm(title, message) {
                return Swal.fire({
                    icon: 'question',
                    title: title,
                    text: message,
                    showCancelButton: true,
                    confirmButtonColor: '#5a3d2b',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Đồng ý',
                    cancelButtonText: 'Hủy'
                });
            }

            // Cấu hình Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyBHTL0ZIZkmRNi7kRF8UJdjR1qhx8cdre4",
                authDomain: "webnoithat-de11f.firebaseapp.com",
                databaseURL: "https://webnoithat-de11f-default-rtdb.firebaseio.com",
                projectId: "webnoithat-de11f",
                storageBucket: "webnoithat-de11f.firebasestorage.app",
                messagingSenderId: "919918511984",
                appId: "1:919918511984:web:d1b260dc52102fd279b1b5",
                measurementId: "G-H1G2WJETSH"
            };

            // Khởi tạo Firebase
            firebase.initializeApp(firebaseConfig);
            const analytics = firebase.analytics();
            const auth = firebase.auth();
            const database = firebase.database();

            // Hiển thị modal
            function showModal(modalId) {
                // Ẩn tất cả các modal
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.classList.remove('active');
                });
                
                // Hiển thị modal được chọn và overlay
                document.getElementById(modalId).classList.add('active');
                document.getElementById('modalOverlay').style.display = 'block';
            }

            // Đóng modal khi click vào overlay
            document.getElementById('modalOverlay').addEventListener('click', function() {
                this.style.display = 'none';
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.classList.remove('active');
                });
            });

            // Cập nhật hàm saveUserData
            async function saveUserData(user, additionalData = {}) {
                if (!user) return false;

                const userData = {
                    email: user.email || '',
                    emailVerified: user.emailVerified || false,
                    displayName: user.displayName || additionalData.fullName || '',
                    lastLogin: new Date().toISOString(),
                    role: 'user',  // Mặc định role là user
                    ...additionalData
                };

                try {
                    // Kiểm tra và tạo reference đến node user
                    const userRef = database.ref('users/' + user.uid);
                    
                    // Lấy dữ liệu hiện tại của user (nếu có)
                    const snapshot = await userRef.once('value');
                    const currentData = snapshot.val() || {};

                    // Gộp dữ liệu mới với dữ liệu hiện tại
                    const updatedData = {
                        ...currentData,
                        ...userData,
                        // Giữ lại createdAt nếu đã tồn tại, nếu không thì tạo mới
                        createdAt: currentData.createdAt || new Date().toISOString()
                    };

                    // Cập nhật dữ liệu
                    await userRef.set(updatedData);
                    return true;
                } catch (error) {
                    console.error('Error saving user data:', error);
                    if (error.code === 'PERMISSION_DENIED') {
                        showError('Lỗi phân quyền', 'Không thể cập nhật thông tin. Vui lòng đăng nhập lại.');
                    } else {
                        showError('Lỗi cập nhật', 'Không thể cập nhật thông tin người dùng. Vui lòng thử lại sau.');
                    }
                    return false;
                }
            }

            // Cập nhật hàm updateLoginStatus
            async function updateLoginStatus(user, status) {
                if (!user) return false;

                try {
                    const statusData = {
                        status: status,
                        timestamp: new Date().toISOString()
                    };

                    // Cập nhật trạng thái đăng nhập
                    await database.ref(`users/${user.uid}/loginStatus`).set(statusData);
                    return true;
                } catch (error) {
                    console.error('Error updating login status:', error);
                    // Chỉ hiển thị lỗi nếu không phải là PERMISSION_DENIED
                    if (error.code !== 'PERMISSION_DENIED') {
                        showError('Lỗi cập nhật', 'Không thể cập nhật trạng thái đăng nhập.');
                    }
                    return false;
                }
            }

            // Cập nhật xử lý đăng nhập
            async function handleLogin(event) {
                event.preventDefault();
                const button = event.target.querySelector('button');
                const email = event.target.querySelector('input[type="email"]').value;
                const password = event.target.querySelector('input[type="password"]').value;
                
                button.disabled = true;
                
                try {
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    
                    const [savedData, updatedStatus] = await Promise.all([
                        saveUserData(user),
                        updateLoginStatus(user, 'online')
                    ]);

                    if (savedData && updatedStatus) {
                        showSuccess('Đăng nhập thành công', 'Chào mừng bạn đã quay trở lại!');
                        document.getElementById('modalOverlay').style.display = 'none';
                        document.querySelectorAll('.modal').forEach(modal => {
                            modal.classList.remove('active');
                        });
                    }
                } catch (error) {
                    console.error('Lỗi đăng nhập:', error);
                    let errorMessage = 'Đã có lỗi xảy ra';
                    switch (error.code) {
                        case 'auth/invalid-email':
                            errorMessage = 'Email không hợp lệ';
                            break;
                        case 'auth/user-disabled':
                            errorMessage = 'Tài khoản đã bị vô hiệu hóa';
                            break;
                        case 'auth/user-not-found':
                            errorMessage = 'Không tìm thấy tài khoản với email này';
                            break;
                        case 'auth/wrong-password':
                            errorMessage = 'Mật khẩu không chính xác';
                            break;
                    }
                    showError('Đăng nhập thất bại', errorMessage);
                } finally {
                    button.disabled = false;
                }
            }

            // Cập nhật xử lý đăng ký
            async function handleRegister(event) {
                event.preventDefault();
                const form = event.target;
                const button = form.querySelector('button');
                const fullName = form.querySelector('input[type="text"]').value;
                const email = form.querySelector('input[type="email"]').value;
                const password = form.querySelectorAll('input[type="password"]')[0].value;
                const confirmPassword = form.querySelectorAll('input[type="password"]')[1].value;

                if (password !== confirmPassword) {
                    showError('Lỗi xác nhận', 'Mật khẩu xác nhận không khớp!');
                    return;
                }

                if (password.length < 6) {
                    showError('Lỗi mật khẩu', 'Mật khẩu phải có ít nhất 6 ký tự!');
                    return;
                }

                button.disabled = true;

                try {
                    // Tạo tài khoản
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;

                    // Lưu thông tin bổ sung
                    const success = await saveUserData(user, {
                        fullName,
                        accountType: 'email',
                        status: 'active'
                    });

                    if (success) {
                        showSuccess('Đăng ký thành công', 'Vui lòng đăng nhập để tiếp tục!');
                        // Reset form
                        form.reset();
                        showModal('loginModal');
                    }
                } catch (error) {
                    console.error('Lỗi đăng ký:', error);
                    let errorMessage = 'Đã có lỗi xảy ra';
                    switch (error.code) {
                        case 'auth/email-already-in-use':
                            errorMessage = 'Email này đã được sử dụng bởi tài khoản khác';
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'Email không hợp lệ';
                            break;
                        case 'auth/operation-not-allowed':
                            errorMessage = 'Tính năng đăng ký tạm thời không khả dụng';
                            break;
                        case 'auth/weak-password':
                            errorMessage = 'Mật khẩu không đủ mạnh';
                            break;
                    }
                    showError('Đăng ký thất bại', errorMessage);
                } finally {
                    button.disabled = false;
                }
            }

            // Xử lý quên mật khẩu
            function handleForgotPassword(event) {
                event.preventDefault();
                const button = event.target.querySelector('button');
                const email = event.target.querySelector('input[type="email"]').value;
                
                button.disabled = true;
                
                auth.sendPasswordResetEmail(email)
                    .then(() => {
                        showSuccess('Gửi email thành công', 'Vui lòng kiểm tra hộp thư của bạn để đặt lại mật khẩu.');
                        showModal('loginModal');
                    })
                    .catch((error) => {
                        console.error('Lỗi gửi email:', error);
                        let errorMessage = 'Đã có lỗi xảy ra';
                        switch (error.code) {
                            case 'auth/invalid-email':
                                errorMessage = 'Email không hợp lệ';
                                break;
                            case 'auth/user-not-found':
                                errorMessage = 'Không tìm thấy tài khoản với email này';
                                break;
                        }
                        showError('Gửi email thất bại', errorMessage);
                    })
                    .finally(() => {
                        button.disabled = false;
                    });
            }

            // Kiểm tra trạng thái đăng nhập
            auth.onAuthStateChanged((user) => {
                const loginBtn = document.querySelector('.login-btn');
                if (user) {
                    updateLoginStatus(user, 'online');
                    
                    loginBtn.innerHTML = `
                        <span>👤</span>
                        <span>${user.email}</span>
                    `;
                    loginBtn.onclick = () => {
                        showConfirm('Đăng xuất', 'Bạn có chắc chắn muốn đăng xuất?')
                            .then((result) => {
                                if (result.isConfirmed) {
                                    updateLoginStatus(user, 'offline').then(() => {
                                        auth.signOut();
                                    });
                                }
                            });
                    };

                    window.addEventListener('beforeunload', () => {
                        updateLoginStatus(user, 'offline');
                    });
                } else {
                    loginBtn.innerHTML = `
                        <span>👤</span>
                        <span>Đăng nhập</span>
                    `;
                    loginBtn.onclick = () => showModal('loginModal');
                }
            });

            // Kiểm tra đăng nhập và điền thông tin vào form liên hệ
            auth.onAuthStateChanged((user) => {
                if (user) {
                    // Load thông tin user từ database
                    database.ref('users/' + user.uid).once('value')
                        .then((snapshot) => {
                            const userData = snapshot.val();
                            if (userData) {
                                document.getElementById('contactName').value = userData.displayName || '';
                                document.getElementById('contactEmail').value = user.email;
                                document.getElementById('contactPhone').value = userData.phone || '';
                            }
                        })
                        .catch((error) => {
                            console.error('Lỗi khi load thông tin user:', error);
                        });
                }
            });

            // Hàm gửi thông tin liên hệ
            function submitContact(event) {
                event.preventDefault();
                
                const user = auth.currentUser;
                const contactData = {
                    name: document.getElementById('contactName').value.trim(),
                    email: document.getElementById('contactEmail').value.trim(),
                    phone: document.getElementById('contactPhone').value.trim(),
                    subject: document.getElementById('contactSubject').value.trim(),
                    message: document.getElementById('contactMessage').value.trim(),
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    status: 'pending'
                };

                // Validate dữ liệu
                if (!contactData.name || !contactData.email || !contactData.phone || !contactData.subject || !contactData.message) {
                    Swal.fire('Lỗi', 'Vui lòng điền đầy đủ thông tin', 'error');
                    return;
                }

                // Validate email
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(contactData.email)) {
                    Swal.fire('Lỗi', 'Email không hợp lệ', 'error');
                    return;
                }

                // Validate phone
                const phoneRegex = /^[0-9]{10,11}$/;
                if (!phoneRegex.test(contactData.phone)) {
                    Swal.fire('Lỗi', 'Số điện thoại không hợp lệ', 'error');
                    return;
                }

                // Show loading
                Swal.fire({
                    title: 'Đang gửi...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Kiểm tra đăng nhập trước khi gửi
                if (!user) {
                    Swal.fire({
                        title: 'Vui lòng đăng nhập',
                        text: 'Bạn cần đăng nhập để gửi thông tin liên hệ',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Đăng nhập',
                        cancelButtonText: 'Hủy'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            showModal('loginModal');
                        }
                    });
                    return;
                }

                // Lưu thông tin liên hệ vào Firebase
                const contactRef = database.ref('contacts').push();
                contactData.userId = user.uid;
                
                contactRef.set(contactData)
                    .then(() => {
                        Swal.fire({
                            title: 'Thành công',
                            text: 'Cảm ơn bạn đã liên hệ. Chúng tôi sẽ phản hồi sớm nhất có thể.',
                            icon: 'success',
                            confirmButtonText: 'OK'
                        }).then(() => {
                            // Reset form
                            document.getElementById('contactForm').reset();
                            // Giữ lại thông tin cá nhân
                            database.ref('users/' + user.uid).once('value')
                                .then((snapshot) => {
                                    const userData = snapshot.val();
                                    if (userData) {
                                        document.getElementById('contactName').value = userData.displayName || '';
                                        document.getElementById('contactEmail').value = user.email;
                                        document.getElementById('contactPhone').value = userData.phone || '';
                                    }
                                });
                        });
                    })
                    .catch((error) => {
                        console.error('Lỗi khi gửi thông tin liên hệ:', error);
                        let errorMessage = 'Không thể gửi thông tin liên hệ. Vui lòng thử lại sau.';
                        
                        if (error.code === 'PERMISSION_DENIED') {
                            errorMessage = 'Bạn không có quyền gửi thông tin liên hệ. Vui lòng đăng nhập lại.';
                            // Tự động đăng xuất nếu có lỗi permission
                            auth.signOut().then(() => {
                                showModal('loginModal');
                            });
                        }
                        
                        Swal.fire({
                            title: 'Lỗi',
                            text: errorMessage,
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    });
            }

            // Hàm để load và hiển thị đánh giá từ Firebase
            function loadTestimonials() {
                const testimonialContainer = document.getElementById('testimonialContainer');
                
                // Lắng nghe thay đổi theo thời gian thực
                database.ref('contacts')
                    .orderByChild('createdAt')
                    .limitToLast(5)
                    .on('value', (snapshot) => {
                        const testimonials = [];
                        snapshot.forEach((childSnapshot) => {
                            testimonials.push({
                                id: childSnapshot.key,
                                ...childSnapshot.val()
                            });
                        });
                        
                        // Đảo ngược mảng để hiển thị mới nhất lên đầu
                        testimonials.reverse();
                        
                        // Xóa nội dung cũ
                        testimonialContainer.innerHTML = '';
                        
                        // Hiển thị từng đánh giá
                        testimonials.forEach(testimonial => {
                            const testimonialCard = document.createElement('div');
                            testimonialCard.className = 'testimonial-card';
                            
                            // Format ngày tháng
                            const date = new Date(testimonial.createdAt);
                            const formattedDate = date.toLocaleDateString('vi-VN', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            });
                            
                            testimonialCard.innerHTML = `
                                <div class="testimonial-content">
                                    <p>"${testimonial.message}"</p>
                                </div>
                                <div class="testimonial-author">
                                    <div class="author-info">
                                        <h4>${testimonial.name}</h4>
                                        <p>${formattedDate}</p>
                                    </div>
                                </div>
                            `;
                            
                            testimonialContainer.appendChild(testimonialCard);
                        });
                    }, (error) => {
                        console.error('Lỗi khi load đánh giá:', error);
                        testimonialContainer.innerHTML = `
                            <div class="testimonial-card">
                                <div class="testimonial-content">
                                    <p>Không thể tải đánh giá. Vui lòng thử lại sau.</p>
                                </div>
                            </div>
                        `;
                    });
            }

            // Hàm để load và hiển thị sản phẩm nổi bật từ Firebase
            function loadFeaturedProducts() {
                const productsContainer = document.getElementById('featuredProductsContainer');
                
                // Lắng nghe thay đổi theo thời gian thực
                database.ref('products')
                    .orderByChild('ngayThem')
                    .limitToLast(6) // Hiển thị 6 sản phẩm mới nhất
                    .on('value', (snapshot) => {
                        const products = [];
                        snapshot.forEach((childSnapshot) => {
                            products.push({
                                id: childSnapshot.key,
                                ...childSnapshot.val()
                            });
                        });
                        
                        // Đảo ngược mảng để hiển thị mới nhất lên đầu
                        products.reverse();
                        
                        // Xóa nội dung cũ
                        productsContainer.innerHTML = '';
                        
                        // Hiển thị từng sản phẩm
                        products.forEach(product => {
                            const productCard = document.createElement('div');
                            productCard.className = 'product-card';
                            
                            // Tính phần trăm giảm giá
                            const discountPercentage = product.giaSauGiam ? 
                                Math.round(((product.giaBan - product.giaSauGiam) / product.giaBan) * 100) : 0;
                            
                            // Format giá tiền
                            const formatPrice = (price) => {
                                return new Intl.NumberFormat('vi-VN', {
                                    style: 'currency',
                                    currency: 'VND'
                                }).format(price);
                            };

                            productCard.innerHTML = `
                                ${discountPercentage > 0 ? `<div class="product-badge">-${discountPercentage}%</div>` : ''}
                                <img src="${product.hinhAnh}" alt="${product.tenSanPham}" class="product-image" 
                                    onerror="this.src='picture/logo.jpg'">
                                <div class="product-info">
                                    <h3>${product.tenSanPham}</h3>
                                    <p class="product-desc">${product.moTa}</p>
                                    <div class="product-price">
                                        ${product.giaSauGiam ? 
                                            `<span class="original-price">${formatPrice(product.giaBan)}</span>
                                             <span class="discounted-price">${formatPrice(product.giaSauGiam)}</span>` :
                                            `<span class="current-price">${formatPrice(product.giaBan)}</span>`
                                        }
                                    </div>
                                    <div class="product-actions">
                                        <button class="btn-primary" onclick="addToCart('${product.id}')">Mua ngay</button>
                                        <button class="btn-secondary" onclick="viewProductDetail('${product.id}')">Chi tiết</button>
                                    </div>
                                </div>
                            `;
                            
                            productsContainer.appendChild(productCard);
                        });
                    }, (error) => {
                        console.error('Lỗi khi load sản phẩm:', error);
                        productsContainer.innerHTML = `
                            <div class="product-card">
                                <div class="product-info">
                                    <p>Không thể tải sản phẩm. Vui lòng thử lại sau.</p>
                                </div>
                            </div>
                        `;
                    });
            }

            // Hàm thêm vào giỏ hàng
            function addToCart(productId) {
                const user = auth.currentUser;
                if (!user) {
                    showConfirm('Vui lòng đăng nhập', 'Bạn cần đăng nhập để thêm sản phẩm vào giỏ hàng')
                        .then((result) => {
                            if (result.isConfirmed) {
                                showModal('loginModal');
                            }
                        });
                    return;
                }

                // Thêm vào giỏ hàng logic sẽ được implement sau
                showSuccess('Thành công', 'Sản phẩm đã được thêm vào giỏ hàng');
            }

            // Hàm xem chi tiết sản phẩm
            function viewProductDetail(productId) {
                // Lưu ID sản phẩm vào localStorage để sử dụng ở trang chi tiết
                localStorage.setItem('selectedProductId', productId);
                // Chuyển hướng đến trang chi tiết
                window.location.href = `product-detail.html?id=${productId}`;
            }

            // Load sản phẩm khi trang được tải
            document.addEventListener('DOMContentLoaded', () => {
                loadTestimonials();
                loadFeaturedProducts();
            });

            // VNPay payment handling
            let selectedBank = 'vietcombank';

            document.querySelectorAll('.bank-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.bank-item').forEach(bank => bank.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedBank = this.querySelector('.bank-name').textContent.toLowerCase().replace(/\s+/g, '');
                });
            });

            // Update checkout button click handler
            document.getElementById('checkout-btn').addEventListener('click', () => {
                const user = auth.currentUser;
                if (!user) {
                    showConfirm('Vui lòng đăng nhập', 'Bạn cần đăng nhập để thanh toán')
                        .then((result) => {
                            if (result.isConfirmed) {
                                showModal('loginModal');
                            }
                        });
                    return;
                }

                // Lấy giỏ hàng từ localStorage
                const cart = JSON.parse(localStorage.getItem('cart')) || [];
                if (cart.length === 0) {
                    showError('Giỏ hàng trống', 'Vui lòng thêm sản phẩm vào giỏ hàng');
                    return;
                }

                // Tính tổng tiền
                const subtotal = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
                const shipping = subtotal > 1000000 ? 0 : 50000;
                const total = subtotal + shipping;

                // Hiển thị modal thanh toán
                document.getElementById('subtotalAmount').textContent = formatPrice(subtotal);
                document.getElementById('totalAmount').textContent = formatPrice(total);
                showModal('paymentModal');
            });

            // Hàm xử lý thanh toán
            async function handlePayment(event) {
                event.preventDefault();
                
                // Kiểm tra form validation
                const form = document.getElementById('paymentForm');
                if (!form.checkValidity()) {
                    // Hiển thị validation message
                    form.reportValidity();
                    return;
                }

                const button = event.target.querySelector('button[type="submit"]');
                button.disabled = true;

                try {
                    // Lấy thông tin từ form
                    const formData = {
                        fullName: document.getElementById('fullName').value.trim(),
                        phone: document.getElementById('phone').value.trim(),
                        email: document.getElementById('email').value.trim(),
                        address: document.getElementById('address').value.trim(),
                        note: document.getElementById('note').value.trim(),
                        paymentMethod: document.querySelector('input[name="paymentMethod"]:checked').value,
                        cart: JSON.parse(localStorage.getItem('cart')) || [],
                        totalAmount: calculateTotal()
                    };

                    // Validate dữ liệu
                    if (!formData.fullName || !formData.phone || !formData.email || !formData.address) {
                        showError('Lỗi', 'Vui lòng điền đầy đủ thông tin bắt buộc');
                        return;
                    }

                    // Validate email
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(formData.email)) {
                        showError('Lỗi', 'Email không hợp lệ');
                        return;
                    }

                    // Validate phone
                    const phoneRegex = /^[0-9]{10,11}$/;
                    if (!phoneRegex.test(formData.phone)) {
                        showError('Lỗi', 'Số điện thoại không hợp lệ');
                        return;
                    }

                    if (formData.paymentMethod === 'vnpay') {
                        // Xử lý thanh toán VNPAY
                        const vnp_TmnCode = 'HPVOQ9TR';
                        const vnp_HashSecret = '7BLLKO9FCUWR84YAX28XZN5SP8D36YV0';
                        const vnp_Url = 'https://sandbox.vnpayment.vn/paymentv2/vpcpay.html';
                        const vnp_ReturnUrl = window.location.origin + '/vnpay_return.html';
                        const vnp_TxnRef = Date.now().toString();
                        const vnp_Amount = formData.totalAmount * 100;
                        const vnp_OrderInfo = `Thanh toán đơn hàng cho ${formData.fullName}`;

                        // Tạo đối tượng chứa thông tin thanh toán
                        const vnpParams = {
                            vnp_Version: '2.1.0',
                            vnp_Command: 'pay',
                            vnp_TmnCode: vnp_TmnCode,
                            vnp_Amount: vnp_Amount,
                            vnp_CurrCode: 'VND',
                            vnp_TxnRef: vnp_TxnRef,
                            vnp_OrderInfo: vnp_OrderInfo,
                            vnp_OrderType: 'other',
                            vnp_Locale: 'vn',
                            vnp_ReturnUrl: vnp_ReturnUrl,
                            vnp_IpAddr: '127.0.0.1',
                            vnp_CreateDate: moment().format('YYYYMMDDHHmmss')
                        };

                        // Sắp xếp các tham số theo thứ tự alphabet
                        const sortedParams = {};
                        Object.keys(vnpParams).sort().forEach(key => {
                            sortedParams[key] = vnpParams[key];
                        });

                        // Tạo chuỗi ký tự cần mã hóa
                        const signData = Object.keys(sortedParams)
                            .map(key => {
                                const value = sortedParams[key];
                                return `${key}=${encodeURIComponent(String(value)).replace(/%20/g, '+')}`;
                            })
                            .join('&');

                        // Tạo chữ ký
                        const hmac = CryptoJS.HmacSHA512(signData, vnp_HashSecret);
                        const vnp_SecureHash = hmac.toString(CryptoJS.enc.Hex);

                        // Thêm chữ ký vào tham số
                        sortedParams.vnp_SecureHash = vnp_SecureHash;

                        // Tạo URL thanh toán
                        const paymentUrl = vnp_Url + '?' + Object.keys(sortedParams)
                            .map(key => {
                                const value = sortedParams[key];
                                return `${key}=${encodeURIComponent(String(value)).replace(/%20/g, '+')}`;
                            })
                            .join('&');

                        // Lưu thông tin đơn hàng vào localStorage
                        const orderInfo = {
                            orderId: vnp_TxnRef,
                            ...formData,
                            status: 'pending',
                            createdAt: new Date().toISOString(),
                            vnpParams: {
                                txnRef: vnp_TxnRef,
                                amount: vnp_Amount,
                                orderInfo: vnp_OrderInfo
                            }
                        };
                        localStorage.setItem('currentOrder', JSON.stringify(orderInfo));

                        // Chuyển hướng đến trang thanh toán VNPAY
                        window.location.href = paymentUrl;
                        return;
                    }

                    // Xử lý thanh toán COD
                    showSuccess('Đặt hàng thành công', 'Cảm ơn bạn đã đặt hàng! Chúng tôi sẽ liên hệ với bạn sớm nhất.');
                    localStorage.removeItem('cart');
                    closeModal('paymentModal');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);

                } catch (error) {
                    console.error('Lỗi xử lý thanh toán:', error);
                    showError('Lỗi thanh toán', 'Có lỗi xảy ra trong quá trình xử lý thanh toán. Vui lòng thử lại sau.');
                } finally {
                    button.disabled = false;
                }
            }

            // Hàm tính tổng tiền
            function calculateTotal() {
                const cart = JSON.parse(localStorage.getItem('cart')) || [];
                const subtotal = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
                const shipping = subtotal > 1000000 ? 0 : 50000;
                return subtotal + shipping;
            }

            // Hàm format giá tiền
            function formatPrice(price) {
                return new Intl.NumberFormat('vi-VN', {
                    style: 'currency',
                    currency: 'VND'
                }).format(price);
            }

            // Hàm load giỏ hàng từ localStorage
            function loadCart() {
                const cart = JSON.parse(localStorage.getItem('cart')) || [];
                const cartItemsContainer = document.getElementById('cart-items');
                
                if (cart.length === 0) {
                    cartItemsContainer.innerHTML = `
                        <div class="empty-cart">
                            <h2>Giỏ hàng trống</h2>
                            <p>Hãy thêm sản phẩm vào giỏ hàng của bạn</p>
                            <a href="products.html" class="continue-shopping">Tiếp tục mua sắm</a>
                        </div>
                    `;
                    updateCartSummary(0, 0, 0);
                    return;
                }

                // Hiển thị sản phẩm trong giỏ hàng
                cartItemsContainer.innerHTML = cart.map(item => {
                    // Đảm bảo ID là chuỗi
                    const itemId = String(item.id);
                    return `
                        <div class="cart-item" data-id="${itemId}">
                            <img src="${item.image}" alt="${item.name}" class="cart-item-image" 
                                onerror="this.src='picture/logo.jpg'">
                            <div class="cart-item-details">
                                <h3>${item.name}</h3>
                            </div>
                            <div class="cart-item-price">
                                ${item.originalPrice > item.price ? 
                                    `<span class="original-price">${formatPrice(item.originalPrice)}</span>` : ''}
                                <span>${formatPrice(item.price)}</span>
                            </div>
                            <div class="quantity-controls">
                                <button class="quantity-btn" onclick="updateQuantity('${itemId}', -1)">-</button>
                                <input type="number" class="quantity-input" value="${item.quantity}" 
                                    min="1" onchange="updateQuantity('${itemId}', this.value - ${item.quantity})">
                                <button class="quantity-btn" onclick="updateQuantity('${itemId}', 1)">+</button>
                            </div>
                            <button class="remove-btn" onclick="removeItem('${itemId}')">×</button>
                        </div>
                    `;
                }).join('');

                // Cập nhật tổng tiền
                updateCartSummary(cart);
            }

            // Hàm cập nhật số lượng sản phẩm
            function updateQuantity(productId, change) {
                let cart = JSON.parse(localStorage.getItem('cart')) || [];
                const itemIndex = cart.findIndex(item => String(item.id) === String(productId));
                
                if (itemIndex > -1) {
                    const newQuantity = cart[itemIndex].quantity + change;
                    if (newQuantity > 0) {
                        cart[itemIndex].quantity = newQuantity;
                        localStorage.setItem('cart', JSON.stringify(cart));
                        loadCart();
                        updateCartCount();
                    }
                }
            }

            // Hàm xóa sản phẩm khỏi giỏ hàng
            function removeItem(productId) {
                console.log('Attempting to remove item with ID:', productId);
                showConfirm('Xác nhận xóa', 'Bạn có chắc muốn xóa sản phẩm này khỏi giỏ hàng?')
                    .then((result) => {
                        console.log('Confirmation result:', result);
                        if (result.isConfirmed) {
                            let cart = JSON.parse(localStorage.getItem('cart')) || [];
                            console.log('Current cart:', cart);
                            
                            // Chuyển đổi tất cả ID về chuỗi để so sánh
                            cart = cart.filter(item => String(item.id) !== String(productId));
                            
                            console.log('Cart after removal:', cart);
                            localStorage.setItem('cart', JSON.stringify(cart));
                            loadCart();
                            updateCartCount();
                        }
                    })
                    .catch(error => {
                        console.error('Error in removeItem:', error);
                    });
            }

            // Hàm cập nhật tổng tiền
            function updateCartSummary(cart) {
                const subtotal = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
                const shipping = subtotal > 1000000 ? 0 : 50000;
                const discount = 0; // Có thể thêm logic giảm giá sau
                const total = subtotal + shipping - discount;

                document.getElementById('subtotal').textContent = formatPrice(subtotal);
                document.getElementById('shipping').textContent = formatPrice(shipping);
                document.getElementById('discount').textContent = formatPrice(discount);
                document.getElementById('total').textContent = formatPrice(total);
            }

            // Load giỏ hàng khi trang được tải
            document.addEventListener('DOMContentLoaded', () => {
                loadCart();
            });

            // Hàm hiển thị modal thanh toán
            async function showPaymentModal() {
                console.log('Starting showPaymentModal...'); // Debug log

                const cart = JSON.parse(localStorage.getItem('cart')) || [];
                if (cart.length === 0) {
                    showError('Giỏ hàng trống', 'Vui lòng thêm sản phẩm vào giỏ hàng');
                    return;
                }

                // Lấy thông tin người dùng từ Firebase
                const user = auth.currentUser;
                console.log('Current user:', user); // Debug log

                if (user) {
                    try {
                        console.log('Fetching user data for UID:', user.uid); // Debug log
                        const userRef = database.ref('users/' + user.uid);
                        const snapshot = await userRef.once('value');
                        const userData = snapshot.val();
                        console.log('Retrieved user data:', userData); // Debug log

                        if (userData) {
                            // Điền thông tin vào form
                            const fullNameInput = document.getElementById('fullName');
                            const emailInput = document.getElementById('email');
                            const phoneInput = document.getElementById('phone');
                            const addressInput = document.getElementById('address');

                            console.log('Form elements:', { // Debug log
                                fullNameInput,
                                emailInput,
                                phoneInput,
                                addressInput
                            });

                            // Điền thông tin với cấu trúc dữ liệu chính xác
                            if (fullNameInput) {
                                fullNameInput.value = userData.fullName || userData.displayName || '';
                                console.log('Set fullName to:', fullNameInput.value); // Debug log
                            }
                            if (emailInput) {
                                emailInput.value = userData.email || '';
                                console.log('Set email to:', emailInput.value); // Debug log
                            }
                            if (phoneInput) {
                                phoneInput.value = userData.phone || '';
                                console.log('Set phone to:', phoneInput.value); // Debug log
                            }
                            if (addressInput) {
                                // Kết hợp địa chỉ từ các trường
                                const address = [
                                    userData.address,
                                    userData.district,
                                    userData.city
                                ].filter(Boolean).join(', ');
                                addressInput.value = address;
                                console.log('Set address to:', addressInput.value); // Debug log
                            }
                        } else {
                            console.log('No user data found in database'); // Debug log
                        }
                    } catch (error) {
                        console.error('Error fetching user data:', error); // Debug log
                        showError('Lỗi', 'Không thể lấy thông tin người dùng. Vui lòng thử lại.');
                    }
                } else {
                    console.log('No user logged in'); // Debug log
                    showError('Vui lòng đăng nhập', 'Bạn cần đăng nhập để thanh toán');
                    showModal('loginModal');
                    return;
                }

                // Tính toán tổng tiền
                const subtotal = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
                const shipping = subtotal > 1000000 ? 0 : 50000;
                const total = subtotal + shipping;

                // Cập nhật hiển thị giá
                document.getElementById('subtotalAmount').textContent = formatPrice(subtotal);
                document.getElementById('shippingAmount').textContent = formatPrice(shipping);
                document.getElementById('totalAmount').textContent = formatPrice(total);

                // Hiển thị sản phẩm trong đơn hàng
                const orderItems = cart.map(item => `
                    <div class="order-item">
                        <img src="${item.image}" alt="${item.name}" class="order-item-image">
                        <div class="order-item-details">
                            <div class="order-item-name">${item.name}</div>
                            <div class="order-item-price">
                                ${formatPrice(item.price)} x ${item.quantity}
                            </div>
                        </div>
                    </div>
                `).join('');
                document.querySelector('.order-items').innerHTML = orderItems;

                // Reset form và steps
                document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
                document.querySelector('.step[data-step="1"]').classList.add('active');
                document.querySelectorAll('.step-content').forEach(content => content.style.display = 'none');
                document.getElementById('step1').style.display = 'block';

                // Hiển thị modal
                showModal('paymentModal');
            }

            // Thêm event listener cho nút thanh toán
            document.getElementById('checkout-btn').addEventListener('click', showPaymentModal);

            // Hàm chuyển bước
            function nextStep(currentStep) {
                // Ẩn bước hiện tại
                document.getElementById(`step${currentStep}`).style.display = 'none';
                // Hiển thị bước tiếp theo
                document.getElementById(`step${currentStep + 1}`).style.display = 'block';
                // Cập nhật trạng thái active của steps
                document.querySelector(`.step[data-step="${currentStep}"]`).classList.remove('active');
                document.querySelector(`.step[data-step="${currentStep + 1}"]`).classList.add('active');

                // Nếu đang ở bước 2, cập nhật thông tin xác nhận
                if (currentStep === 2) {
                    updateConfirmationInfo();
                }
            }   

            function prevStep(currentStep) {
                // Ẩn bước hiện tại
                document.getElementById(`step${currentStep}`).style.display = 'none';
                // Hiển thị bước trước đó
                document.getElementById(`step${currentStep - 1}`).style.display = 'block';
                // Cập nhật trạng thái active của steps
                document.querySelector(`.step[data-step="${currentStep}"]`).classList.remove('active');
                document.querySelector(`.step[data-step="${currentStep - 1}"]`).classList.add('active');
            }

            // Hàm cập nhật thông tin xác nhận
            function updateConfirmationInfo() {
                // Thông tin giao hàng
                const deliveryInfo = `
                    <div class="confirmation-info">
                        <p><strong>Họ và tên:</strong> ${document.getElementById('fullName').value}</p>
                        <p><strong>Số điện thoại:</strong> ${document.getElementById('phone').value}</p>
                        <p><strong>Email:</strong> ${document.getElementById('email').value}</p>
                        <p><strong>Địa chỉ:</strong> ${document.getElementById('address').value}</p>
                        <p><strong>Ghi chú:</strong> ${document.getElementById('note').value || 'Không có'}</p>
                    </div>
                `;
                document.getElementById('confirmDeliveryInfo').innerHTML = deliveryInfo;

                // Phương thức thanh toán
                const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
                const paymentInfo = `
                    <div class="confirmation-info">
                        <p><strong>Phương thức:</strong> ${paymentMethod.nextElementSibling.querySelector('h4').textContent}</p>
                    </div>
                `;
                document.getElementById('confirmPaymentMethod').innerHTML = paymentInfo;

                // Chi tiết đơn hàng
                const cart = JSON.parse(localStorage.getItem('cart')) || [];
                const orderItems = cart.map(item => `
                    <div class="order-item">
                        <img src="${item.image}" alt="${item.name}" class="order-item-image">
                        <div class="order-item-details">
                            <div class="order-item-name">${item.name}</div>
                            <div class="order-item-price">
                                ${formatPrice(item.price)} x ${item.quantity}
                            </div>
                        </div>
                    </div>
                `).join('');
                document.getElementById('confirmOrderItems').innerHTML = orderItems;
            }

            function closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
                document.getElementById('modalOverlay').style.display = 'none';
            }

            // Hàm tạo URL VNPAY và ký SHA512
            function sortObject(obj) {
                const sorted = {};
                Object.keys(obj).sort().forEach(key => {
                    sorted[key] = obj[key];
                });
                return sorted;
            }

            function getVnpCreateDate() {
                const now = new Date();
                const yyyy = now.getFullYear();
                const MM = String(now.getMonth() + 1).padStart(2, '0');
                const dd = String(now.getDate()).padStart(2, '0');
                const HH = String(now.getHours()).padStart(2, '0');
                const mm = String(now.getMinutes()).padStart(2, '0');
                const ss = String(now.getSeconds()).padStart(2, '0');
                return `${yyyy}${MM}${dd}${HH}${mm}${ss}`;
            }

            async function handlePayment(event) {
                event.preventDefault();
                const cart = JSON.parse(localStorage.getItem('cart')) || [];
                if (cart.length === 0) {
                    showError('Giỏ hàng trống', 'Vui lòng thêm sản phẩm vào giỏ hàng');
                    return;
                }
                const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
                // Lấy thông tin đơn hàng
                const fullName = document.getElementById('fullName').value;
                const phone = document.getElementById('phone').value;
                const email = document.getElementById('email').value;
                const address = document.getElementById('address').value;
                const note = document.getElementById('note').value;
                // Tính toán tổng tiền
                const subtotal = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
                const shipping = subtotal > 1000000 ? 0 : 50000;
                const total = subtotal + shipping;
                // Tạo mã đơn hàng
                const orderKey = 'ORDER_' + Date.now();
                const order = {
                    fullName,
                    phone,
                    email,
                    address,
                    note,
                    items: cart,
                    subtotal,
                    shipping,
                    grandTotal: total,
                    paymentMethod,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };
                if (paymentMethod === 'vnpay') {
                    // Cấu hình VNPAY
                    const vnp_TmnCode = 'HPVOQ9TR';
                    const vnp_HashSecret = '7BLLKO9FCUWR84YAX28XZN5SP8D36YV0';
                    const vnp_Url = 'https://sandbox.vnpayment.vn/paymentv2/vpcpay.html';
                    const vnp_ReturnUrl = window.location.origin + '/vnpay_return.html';
                    
                    // Tạo tham số thanh toán
                    const vnp_Params = {
                        vnp_Version: '2.1.0',
                        vnp_Command: 'pay',
                        vnp_TmnCode: vnp_TmnCode,
                        vnp_Locale: 'vn',
                        vnp_CurrCode: 'VND',
                        vnp_TxnRef: orderKey.slice(-8).toUpperCase(),
                        vnp_OrderInfo: `Thanh toan don hang ${orderKey.slice(-8).toUpperCase()}`,
                        vnp_OrderType: 'other',
                        vnp_Amount: Math.round(total * 100), // Nhân 100 vì VNPAY yêu cầu
                        vnp_ReturnUrl: vnp_ReturnUrl,
                        vnp_IpAddr: '127.0.0.1',
                        vnp_CreateDate: moment().format('YYYYMMDDHHmmss')
                    };

                    // Sắp xếp tham số theo thứ tự alphabet
                    const sortedParams = {};
                    Object.keys(vnp_Params).sort().forEach(key => {
                        sortedParams[key] = vnp_Params[key];
                    });

                    // Tạo chuỗi ký tự cần mã hóa
                    const signData = Object.keys(sortedParams)
                        .map(key => {
                            const value = sortedParams[key];
                            return `${key}=${encodeURIComponent(String(value)).replace(/%20/g, '+')}`;
                        })
                        .join('&');

                    // Tạo chữ ký
                    const hmac = CryptoJS.HmacSHA512(signData, vnp_HashSecret);
                    const vnp_SecureHash = hmac.toString(CryptoJS.enc.Hex);

                    // Thêm chữ ký vào tham số
                    sortedParams.vnp_SecureHash = vnp_SecureHash;

                    // Tạo URL thanh toán
                    const paymentUrl = vnp_Url + '?' + Object.keys(sortedParams)
                        .map(key => {
                            const value = sortedParams[key];
                            return `${key}=${encodeURIComponent(String(value)).replace(/%20/g, '+')}`;
                        })
                        .join('&');

                    // Lưu thông tin đơn hàng vào localStorage
                    localStorage.setItem('currentOrder', JSON.stringify({ orderKey, ...order }));

                    // Chuyển hướng đến trang thanh toán VNPAY
                    window.location.href = paymentUrl;
                    return;
                }
                // ... existing code for COD payment ...
            }

            // Hàm xử lý thanh toán
            async function processPayment() {
                const paymentMethod = document.querySelector('input[name="payment_method"]:checked').value;
                const cart = JSON.parse(localStorage.getItem('cart')) || [];
                
                if (cart.length === 0) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi!',
                        text: 'Giỏ hàng của bạn đang trống.',
                        showConfirmButton: true
                    });
                    return;
                }

                // Tính tổng tiền
                const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

                if (paymentMethod === 'vnpay') {
                    // Tạo thông tin đơn hàng cho VNPAY
                    const orderInfo = {
                        orderId: 'ORDER_' + Date.now(),
                        orderDescription: 'Thanh toan don hang tai Am Coffee and Cake',
                        amount: total
                    };

                    // Xử lý thanh toán VNPAY
                    await processVnpayPayment(orderInfo);
                } else {
                    // Xử lý thanh toán COD
                    Swal.fire({
                        icon: 'success',
                        title: 'Đặt hàng thành công!',
                        text: 'Cảm ơn bạn đã đặt hàng. Chúng tôi sẽ liên hệ với bạn sớm nhất có thể.',
                        showConfirmButton: true
                    }).then(() => {
                        // Xóa giỏ hàng
                        localStorage.removeItem('cart');
                        // Cập nhật số lượng sản phẩm trong giỏ hàng
                        updateCartCount();
                        // Chuyển hướng về trang chủ
                        window.location.href = '/index.html';
                    });
                }
            }

            // Thêm event listener cho nút thanh toán
            document.getElementById('checkout-button').addEventListener('click', processPayment);

            async function processVNPayPayment(order, orderKey) {
                const vnp_TmnCode = "HPVOQ9TR";
                const vnp_HashSecret = "7BLLKO9FCUWR84YAX28XZN5SP8D36YV0";
                const vnp_Url = "https://sandbox.vnpayment.vn/paymentv2/vpcpay.html";
                const vnp_ReturnUrl = window.location.origin + "/vnpay_return.html";

                // Lấy địa chỉ IP của người dùng
                async function getClientIp() {
                    try {
                        const response = await fetch('https://api.ipify.org?format=json');
                        const data = await response.json();
                        return data.ip || '127.0.0.1';
                    } catch (error) {
                        console.error('Error fetching IP:', error);
                        return '127.0.0.1';
                    }
                }

                const vnp_Params = {
                    vnp_Version: '2.1.0',
                    vnp_Command: 'pay',
                    vnp_TmnCode: vnp_TmnCode,
                    vnp_Locale: 'vn',
                    vnp_CurrCode: 'VND',
                    vnp_TxnRef: orderKey.slice(-8).toUpperCase(),
                    vnp_OrderInfo: `Thanh toan don hang ${orderKey.slice(-8).toUpperCase()}`,
                    vnp_OrderType: 'other',
                    vnp_Amount: Math.round(order.grandTotal * 100),
                    vnp_ReturnUrl: vnp_ReturnUrl,
                    vnp_IpAddr: await getClientIp(),
                    vnp_CreateDate: moment().format('YYYYMMDDHHmmss')
                };

                // Sắp xếp tham số
                const sortedParams = Object.keys(vnp_Params).sort().reduce((acc, key) => {
                    acc[key] = vnp_Params[key];
                    return acc;
                }, {});

                // Tạo chuỗi ký tự cần mã hóa
                const signData = Object.keys(sortedParams)
                    .map(key => `${key}=${encodeURIComponent(sortedParams[key]).replace(/%20/g, '+')}`)
                    .join('&');

                // Tạo chữ ký
                const hmac = CryptoJS.HmacSHA512(signData, vnp_HashSecret);
                const vnp_SecureHash = hmac.toString(CryptoJS.enc.Hex);

                // Thêm chữ ký vào tham số
                sortedParams.vnp_SecureHash = vnp_SecureHash;

                // Tạo URL thanh toán
                const paymentUrl = vnp_Url + '?' + Object.keys(sortedParams)
                    .map(key => `${key}=${encodeURIComponent(sortedParams[key]).replace(/%20/g, '+')}`)
                    .join('&');

                // Chuyển hướng
                window.location.href = paymentUrl;
            }   

            // Hàm cập nhật số lượng sản phẩm trong giỏ hàng
            function updateCartCount() {
                const cart = JSON.parse(localStorage.getItem('cart')) || [];
                const totalItems = cart.reduce((total, item) => total + item.quantity, 0);
                const cartCountElement = document.querySelector('.cart-btn span:last-child');
                if (cartCountElement) {
                    cartCountElement.textContent = `Giỏ hàng (${totalItems})`;
                }
            }

            // Khai báo biến toàn cục
            window.activePromoCode = null;

            // Hàm tính tổng tiền tạm tính
            function calculateSubtotal() {
                const cart = JSON.parse(localStorage.getItem('cart')) || [];
                return cart.reduce((total, item) => total + (item.price * item.quantity), 0);
            }

            // Hàm kiểm tra và áp dụng mã giảm giá
            function applyPromoCode() {
                const promoCodeInput = document.getElementById('promoCode');
                const promoCode = promoCodeInput.value.trim().toUpperCase();
                const messageElement = document.getElementById('promoCodeMessage');
                const activePromoElement = document.getElementById('activePromo');
                
                console.log('Mã giảm giá nhập vào:', promoCode);
                
                if (!promoCode) {
                    messageElement.textContent = 'Vui lòng nhập mã giảm giá';
                    messageElement.className = 'promo-code-message error';
                    return;
                }

                // Kiểm tra nếu đã có mã giảm giá đang áp dụng
                if (window.activePromoCode) {
                    messageElement.textContent = 'Bạn đã áp dụng một mã giảm giá. Vui lòng xóa mã hiện tại trước khi áp dụng mã mới.';
                    messageElement.className = 'promo-code-message error';
                    return;
                }

                // Lấy thông tin khuyến mãi từ Firebase
                const promotionsRef = database.ref('promotions');
                console.log('Đang truy vấn Firebase...');
                
                promotionsRef.once('value')
                    .then((snapshot) => {
                        const promotions = snapshot.val();
                        console.log('Dữ liệu khuyến mãi từ Firebase:', promotions);
                        
                        if (!promotions) {
                            messageElement.textContent = 'Không tìm thấy thông tin khuyến mãi';
                            messageElement.className = 'promo-code-message error';
                            return;
                        }

                        const promo = Object.values(promotions).find(p => p.promoCode === promoCode);
                        console.log('Mã khuyến mãi tìm thấy:', promo);

                        if (!promo) {
                            messageElement.textContent = 'Mã giảm giá không hợp lệ';
                            messageElement.className = 'promo-code-message error';
                            return;
                        }

                        // Kiểm tra thời gian hiệu lực
                        const now = new Date();
                        const startDate = new Date(promo.startDate);
                        const endDate = new Date(promo.endDate);
                        
                        console.log('Thời gian kiểm tra:', {
                            now: now,
                            startDate: startDate,
                            endDate: endDate
                        });

                        if (now < startDate || now > endDate) {
                            messageElement.textContent = 'Mã giảm giá đã hết hạn hoặc chưa có hiệu lực';
                            messageElement.className = 'promo-code-message error';
                            return;
                        }

                        // Kiểm tra trạng thái
                        if (promo.status !== 'active') {
                            messageElement.textContent = 'Mã giảm giá không còn hiệu lực';
                            messageElement.className = 'promo-code-message error';
                            return;
                        }

                        // Kiểm tra giá trị đơn hàng tối thiểu
                        const subtotal = calculateSubtotal();
                        console.log('Giá trị đơn hàng:', {
                            subtotal: subtotal,
                            minOrderValue: promo.minOrderValue
                        });

                        if (subtotal < promo.minOrderValue) {
                            messageElement.textContent = `Đơn hàng cần đạt tối thiểu ${formatPrice(promo.minOrderValue)} để áp dụng mã này`;
                            messageElement.className = 'promo-code-message error';
                            return;
                        }

                        // Áp dụng mã giảm giá
                        window.activePromoCode = promo;
                        messageElement.textContent = 'Áp dụng mã giảm giá thành công!';
                        messageElement.className = 'promo-code-message success';

                        // Hiển thị thông tin khuyến mãi
                        activePromoElement.innerHTML = `
                            <div class="promo-title">
                                <span class="icon">${promo.icon || '🎁'}</span>
                                <h4>${promo.title}</h4>
                            </div>
                            <div class="promo-description">${promo.description}</div>
                            <div class="promo-amount">Giảm giá: ${formatPrice(promo.voucherAmount)}</div>
                            <button class="remove-promo" onclick="removePromoCode()">Xóa mã giảm giá</button>
                        `;
                        activePromoElement.classList.add('show');

                        // Cập nhật tổng tiền
                        updateTotal();
                    })
                    .catch((error) => {
                        console.error('Lỗi chi tiết khi kiểm tra mã giảm giá:', error);
                        messageElement.textContent = 'Có lỗi xảy ra khi kiểm tra mã giảm giá';
                        messageElement.className = 'promo-code-message error';
                    });
            }

            // Hàm xóa mã giảm giá
            function removePromoCode() {
                window.activePromoCode = null;
                document.getElementById('promoCode').value = '';
                document.getElementById('promoCodeMessage').textContent = '';
                document.getElementById('promoCodeMessage').className = 'promo-code-message';
                document.getElementById('activePromo').classList.remove('show');
                updateTotal();
            }

            // Cập nhật hàm updateTotal để tính toán giảm giá
            function updateTotal() {
                const subtotal = calculateSubtotal();
                const shipping = subtotal > 1000000 ? 0 : 50000;
                let discount = 0;

                if (window.activePromoCode) {
                    discount = window.activePromoCode.voucherAmount;
                }

                const total = subtotal + shipping - discount;
                
                document.getElementById('subtotal').textContent = formatPrice(subtotal);
                document.getElementById('shipping').textContent = formatPrice(shipping);
                document.getElementById('discount').textContent = formatPrice(discount);
                document.getElementById('total').textContent = formatPrice(total);
            }

            // Thêm hàm submitOrder mới
            async function submitOrder() {
                // Lấy thông tin từ form
                const formData = {
                    fullName: document.getElementById('fullName').value.trim(),
                    phone: document.getElementById('phone').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    address: document.getElementById('address').value.trim(),
                    note: document.getElementById('note').value.trim(),
                    paymentMethod: document.querySelector('input[name="paymentMethod"]:checked').value,
                    cart: JSON.parse(localStorage.getItem('cart')) || [],
                    totalAmount: calculateTotal()
                };

                // Validate dữ liệu
                if (!formData.fullName || !formData.phone || !formData.email || !formData.address) {
                    showError('Lỗi', 'Vui lòng điền đầy đủ thông tin bắt buộc');
                    return;
                }

                // Validate email
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(formData.email)) {
                    showError('Lỗi', 'Email không hợp lệ');
                    return;
                }

                // Validate phone
                const phoneRegex = /^[0-9]{10,11}$/;
                if (!phoneRegex.test(formData.phone)) {
                    showError('Lỗi', 'Số điện thoại không hợp lệ');
                    return;
                }

                try {
                    if (formData.paymentMethod === 'vnpay') {
                        // Xử lý thanh toán VNPAY
                        const vnp_TmnCode = 'HPVOQ9TR';
                        const vnp_HashSecret = '7BLLKO9FCUWR84YAX28XZN5SP8D36YV0';
                        const vnp_Url = 'https://sandbox.vnpayment.vn/paymentv2/vpcpay.html';
                        const vnp_ReturnUrl = window.location.origin + '/vnpay_return.html';
                        const vnp_TxnRef = Date.now().toString();
                        const vnp_Amount = formData.totalAmount * 100;
                        const vnp_OrderInfo = `Thanh toán đơn hàng cho ${formData.fullName}`;

                        // Tạo đối tượng chứa thông tin thanh toán
                        const vnpParams = {
                            vnp_Version: '2.1.0',
                            vnp_Command: 'pay',
                            vnp_TmnCode: vnp_TmnCode,
                            vnp_Amount: vnp_Amount,
                            vnp_CurrCode: 'VND',
                            vnp_TxnRef: vnp_TxnRef,
                            vnp_OrderInfo: vnp_OrderInfo,
                            vnp_OrderType: 'other',
                            vnp_Locale: 'vn',
                            vnp_ReturnUrl: vnp_ReturnUrl,
                            vnp_IpAddr: '127.0.0.1',
                            vnp_CreateDate: moment().format('YYYYMMDDHHmmss')
                        };

                        // Sắp xếp các tham số theo thứ tự alphabet
                        const sortedParams = {};
                        Object.keys(vnpParams).sort().forEach(key => {
                            sortedParams[key] = vnpParams[key];
                        });

                        // Tạo chuỗi ký tự cần mã hóa
                        const signData = Object.keys(sortedParams)
                            .map(key => {
                                const value = sortedParams[key];
                                return `${key}=${encodeURIComponent(String(value)).replace(/%20/g, '+')}`;
                            })
                            .join('&');

                        // Tạo chữ ký
                        const hmac = CryptoJS.HmacSHA512(signData, vnp_HashSecret);
                        const vnp_SecureHash = hmac.toString(CryptoJS.enc.Hex);

                        // Thêm chữ ký vào tham số
                        sortedParams.vnp_SecureHash = vnp_SecureHash;

                        // Tạo URL thanh toán
                        const paymentUrl = vnp_Url + '?' + Object.keys(sortedParams)
                            .map(key => {
                                const value = sortedParams[key];
                                return `${key}=${encodeURIComponent(String(value)).replace(/%20/g, '+')}`;
                            })
                            .join('&');

                        // Lưu thông tin đơn hàng vào localStorage
                        const orderInfo = {
                            orderId: vnp_TxnRef,
                            ...formData,
                            status: 'pending',
                            createdAt: new Date().toISOString(),
                            vnpParams: {
                                txnRef: vnp_TxnRef,
                                amount: vnp_Amount,
                                orderInfo: vnp_OrderInfo
                            }
                        };
                        localStorage.setItem('currentOrder', JSON.stringify(orderInfo));

                        // Chuyển hướng đến trang thanh toán VNPAY
                        window.location.href = paymentUrl;
                        return;
                    }

                    // Xử lý thanh toán COD
                    showSuccess('Đặt hàng thành công', 'Cảm ơn bạn đã đặt hàng! Chúng tôi sẽ liên hệ với bạn sớm nhất.');
                    localStorage.removeItem('cart');
                    closeModal('paymentModal');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);

                } catch (error) {
                    console.error('Lỗi xử lý thanh toán:', error);
                    showError('Lỗi thanh toán', 'Có lỗi xảy ra trong quá trình xử lý thanh toán. Vui lòng thử lại sau.');
                }
            }
        </script>
        <script src="https://app.tudongchat.com/js/chatbox.js"></script>
        <script>
          const tudong_chatbox = new TuDongChat('fvnnpQFt5lp13VAR7GEiK')
          tudong_chatbox.initial()
        </script>
    </body>
</html>
