<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>T√†i kho·∫£n - N·ªôi th·∫•t M·ªôc Nhi√™n</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
        
        <!-- Firebase SDK -->
        <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
        
        <!-- Sweetalert2 -->
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                font-family: 'Montserrat', sans-serif;
                background-color: #f9f7f3;
            }
            .header-top {
                display: flex;
                align-items: center;
                justify-content: center;
                background-color: #5a3d2b;
                padding: 18px 0 12px 0;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            }
            .logo {
                width: 90px;
                height: 90px;
                margin-right: 18px;
                border-radius: 60%;
                border: 3px solid #e9c46a;
                box-shadow: 0 0 15px rgba(233, 196, 106, 0.6);
                transition: transform 0.3s, box-shadow 0.3s;
                object-fit: cover;
            }
            .store-name {
                font-family: 'Great Vibes', cursive;
                font-size: 2.7rem;
                font-weight: 400;
                color: #e9c46a;
                text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
                letter-spacing: 1.5px;
            }
            .header-nav {
                width: 100%;
                background-color: #4a3322;
                box-shadow: 0 2px 8px rgba(0,0,0,0.04);
                display: flex;
                justify-content: center;
            }
            .nav-links {
                display: flex;
                align-items: center;
                gap: 10px;
                flex-wrap: wrap;
                justify-content: center;
                padding: 0 10px;
                min-height: 48px;
            }
            .nav-btn {
                font-family: 'Montserrat', sans-serif;
                text-decoration: none;
                color: #f9f7f3;
                font-weight: 500;
                padding: 8px 12px;
                border-radius: 5px;
                transition: all 0.3s;
                border: 1px solid transparent;
                letter-spacing: 0.5px;
                text-transform: uppercase;
                font-size: 0.75rem;
                position: relative;
                white-space: nowrap;
            }
            .nav-btn:hover {
                background-color: rgba(233, 196, 106, 0.2);
                border-color: #e9c46a;
            }
            .active {
                background-color: rgba(233, 196, 106, 0.2);
                border: 1px solid #e9c46a;
            }

            /* Member Page Styles */
            .member-container {
                max-width: 1200px;
                margin: 40px auto;
                padding: 0 20px;
                display: grid;
                grid-template-columns: 250px 1fr;
                gap: 30px;
            }

            .member-sidebar {
                background: white;
                border-radius: 12px;
                padding: 20px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.08);
                height: fit-content;
            }

            .member-avatar {
                width: 100px;
                height: 100px;
                border-radius: 50%;
                margin: 0 auto 20px;
                display: block;
                border: 3px solid #e9c46a;
            }

            .member-name {
                text-align: center;
                font-size: 1.2rem;
                color: #5a3d2b;
                margin-bottom: 5px;
            }

            .member-email {
                text-align: center;
                color: #666;
                font-size: 0.9rem;
                margin-bottom: 20px;
            }

            .sidebar-menu {
                list-style: none;
            }

            .sidebar-menu li {
                margin-bottom: 10px;
            }

            .sidebar-menu a {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 10px;
                color: #5a3d2b;
                text-decoration: none;
                border-radius: 6px;
                transition: all 0.3s;
            }

            .sidebar-menu a:hover,
            .sidebar-menu a.active {
                background: #f9f7f3;
                color: #e9c46a;
            }

            .sidebar-menu i {
                font-size: 1.2rem;
            }

            .member-content {
                background: white;
                border-radius: 12px;
                padding: 30px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            }

            .content-header {
                margin-bottom: 30px;
            }

            .content-header h2 {
                font-size: 1.8rem;
                color: #5a3d2b;
                margin-bottom: 10px;
            }

            .content-header p {
                color: #666;
            }

            /* Form Styles */
            .form-group {
                margin-bottom: 20px;
            }

            .form-group label {
                display: block;
                margin-bottom: 8px;
                color: #5a3d2b;
                font-weight: 500;
            }

            .form-control {
                width: 100%;
                padding: 12px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 1rem;
                transition: all 0.3s;
            }

            .form-control:focus {
                outline: none;
                border-color: #e9c46a;
                box-shadow: 0 0 0 3px rgba(233, 196, 106, 0.2);
            }

            .btn {
                padding: 12px 24px;
                border: none;
                border-radius: 6px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
                font-size: 1rem;
            }

            .btn-primary {
                background: #e9c46a;
                color: #5a3d2b;
            }

            .btn-primary:hover {
                background: #5a3d2b;
                color: #e9c46a;
            }

            /* Order History Styles */
            .order-list {
                display: grid;
                gap: 20px;
            }

            .order-card {
                border: 1px solid #ddd;
                border-radius: 8px;
                overflow: hidden;
            }

            .order-header {
                background: #f9f7f3;
                padding: 15px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .order-number {
                font-weight: 600;
                color: #5a3d2b;
            }

            .order-status {
                padding: 5px 12px;
                border-radius: 20px;
                font-size: 0.9rem;
                font-weight: 500;
            }

            .status-pending {
                background: #fff3e0;
                color: #e65100;
            }

            .status-processing {
                background: #e3f2fd;
                color: #1565c0;
            }

            .status-completed {
                background: #e8f5e9;
                color: #2e7d32;
            }

            .status-cancelled {
                background: #ffebee;
                color: #c62828;
            }

            .order-items {
                padding: 15px;
            }

            .order-item {
                display: flex;
                gap: 15px;
                margin-bottom: 15px;
                padding-bottom: 15px;
                border-bottom: 1px solid #eee;
            }

            .order-item:last-child {
                margin-bottom: 0;
                padding-bottom: 0;
                border-bottom: none;
            }

            .item-image {
                width: 80px;
                height: 80px;
                object-fit: cover;
                border-radius: 6px;
            }

            .item-details {
                flex: 1;
            }

            .item-name {
                font-weight: 500;
                color: #5a3d2b;
                margin-bottom: 5px;
            }

            .item-price {
                color: #666;
                font-size: 0.9rem;
            }

            .order-footer {
                padding: 15px;
                background: #f9f7f3;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .order-total {
                font-weight: 600;
                color: #5a3d2b;
            }

            .order-actions {
                display: flex;
                gap: 10px;
            }

            .btn-outline {
                background: transparent;
                border: 2px solid #e9c46a;
                color: #5a3d2b;
            }

            .btn-outline:hover {
                background: #e9c46a;
                color: #5a3d2b;
            }

            @media (max-width: 768px) {
                .member-container {
                    grid-template-columns: 1fr;
                }
                
                .member-sidebar {
                    position: sticky;
                    top: 20px;
                }
            }
        </style>
    </head>
    <body>
        <div class="header-top">
            <img src="picture/logo.jpg" alt="M·ªôc Nhi√™n Logo" class="logo">
            <div class="store-name">N·ªôi th·∫•t M·ªôc Nhi√™n</div>
        </div>
        <nav class="header-nav">
            <div class="nav-links">
                <a href="index.html" class="nav-btn">Trang ch·ªß</a>
                <a href="san-pham.html" class="nav-btn">S·∫£n ph·∫©m</a>
                <a href="bo-suu-tap.html" class="nav-btn">B·ªô s∆∞u t·∫≠p</a>
                <a href="khuyen-mai.html" class="nav-btn">Khuy·∫øn m√£i</a>
                <a href="tin-tuc.html" class="nav-btn">Tin t·ª©c</a>
                <a href="thanh-vien.html" class="nav-btn active">T√†i kho·∫£n</a>
                <a href="chinh-sach.html" class="nav-btn">Ch√≠nh s√°ch</a>
                <a href="ve-chung-toi.html" class="nav-btn">V·ªÅ ch√∫ng t√¥i</a>
            </div>
        </nav>

        <div class="member-container">
            <div class="member-sidebar">
                <img src="picture/logo.jpg" alt="Avatar" class="member-avatar">
                <h3 class="member-name" id="userName">Loading...</h3>
                <p class="member-email" id="userEmail">Loading...</p>
                
                <ul class="sidebar-menu">
                    <li><a href="#" class="active" onclick="showSection('profile')">
                        <i>üë§</i> Th√¥ng tin c√° nh√¢n
                    </a></li>
                    <li><a href="#" onclick="showSection('orders')">
                        <i>üì¶</i> L·ªãch s·ª≠ ƒë·∫∑t h√†ng
                    </a></li>
                    <li><a href="#" onclick="showSection('address')">
                        <i>üìç</i> ƒê·ªãa ch·ªâ giao h√†ng
                    </a></li>
                    <li><a href="#" onclick="showSection('password')">
                        <i>üîí</i> ƒê·ªïi m·∫≠t kh·∫©u
                    </a></li>
                    <li><a href="#" onclick="logout()">
                        <i>üö™</i> ƒêƒÉng xu·∫•t
                    </a></li>
                </ul>
            </div>

            <div class="member-content">
                <!-- Profile Section -->
                <div id="profileSection" class="content-section">
                    <div class="content-header">
                        <h2>Th√¥ng tin c√° nh√¢n</h2>
                        <p>C·∫≠p nh·∫≠t th√¥ng tin c√° nh√¢n c·ªßa b·∫°n</p>
                    </div>
                    <form id="profileForm" onsubmit="updateProfile(event)">
                        <div class="form-group">
                            <label for="fullName">H·ªç v√† t√™n</label>
                            <input type="text" id="fullName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="phone">S·ªë ƒëi·ªán tho·∫°i</label>
                            <input type="tel" id="phone" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" class="form-control" disabled>
                        </div>
                        <button type="submit" class="btn btn-primary">C·∫≠p nh·∫≠t th√¥ng tin</button>
                    </form>
                </div>

                <!-- Orders Section -->
                <div id="ordersSection" class="content-section" style="display: none;">
                    <div class="content-header">
                        <h2>L·ªãch s·ª≠ ƒë·∫∑t h√†ng</h2>
                        <p>Xem l·∫°i c√°c ƒë∆°n h√†ng c·ªßa b·∫°n</p>
                    </div>
                    <div class="order-list" id="orderList">
                        <!-- Orders will be dynamically added here -->
                    </div>
                </div>

                <!-- Address Section -->
                <div id="addressSection" class="content-section" style="display: none;">
                    <div class="content-header">
                        <h2>ƒê·ªãa ch·ªâ giao h√†ng</h2>
                        <p>Qu·∫£n l√Ω ƒë·ªãa ch·ªâ giao h√†ng c·ªßa b·∫°n</p>
                    </div>
                    <form id="addressForm" onsubmit="updateAddress(event)">
                        <div class="form-group">
                            <label for="address">ƒê·ªãa ch·ªâ</label>
                            <input type="text" id="address" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="city">Th√†nh ph·ªë</label>
                            <input type="text" id="city" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="district">Qu·∫≠n/Huy·ªán</label>
                            <input type="text" id="district" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-primary">C·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ</button>
                    </form>
                </div>

                <!-- Password Section -->
                <div id="passwordSection" class="content-section" style="display: none;">
                    <div class="content-header">
                        <h2>ƒê·ªïi m·∫≠t kh·∫©u</h2>
                        <p>C·∫≠p nh·∫≠t m·∫≠t kh·∫©u c·ªßa b·∫°n</p>
                    </div>
                    <form id="passwordForm" onsubmit="updatePassword(event)">
                        <div class="form-group">
                            <label for="currentPassword">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
                            <input type="password" id="currentPassword" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="newPassword">M·∫≠t kh·∫©u m·ªõi</label>
                            <input type="password" id="newPassword" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
                            <input type="password" id="confirmPassword" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-primary">ƒê·ªïi m·∫≠t kh·∫©u</button>
                    </form>
                </div>
            </div>
        </div>

        <script>
            // C·∫•u h√¨nh Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyBHTL0ZIZkmRNi7kRF8UJdjR1qhx8cdre4",
                authDomain: "webnoithat-de11f.firebaseapp.com",
                databaseURL: "https://webnoithat-de11f-default-rtdb.firebaseio.com",
                projectId: "webnoithat-de11f",
                storageBucket: "webnoithat-de11f.firebasestorage.app",
                messagingSenderId: "919918511984",
                appId: "1:919918511984:web:d1b260dc52102fd279b1b5",
                measurementId: "G-H1G2WJETSH"
            };

            // Kh·ªüi t·∫°o Firebase
            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();
            const auth = firebase.auth();

            // Bi·∫øn l∆∞u tr·ªØ th√¥ng tin user hi·ªán t·∫°i
            let currentUser = null;

            // Ki·ªÉm tra ƒëƒÉng nh·∫≠p v√† load d·ªØ li·ªáu
            auth.onAuthStateChanged((user) => {
                if (!user) {
                    Swal.fire({
                        title: 'Vui l√≤ng ƒëƒÉng nh·∫≠p',
                        text: 'B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p trang n√†y',
                        icon: 'warning',
                        confirmButtonText: 'ƒêƒÉng nh·∫≠p'
                    }).then(() => {
                        window.location.href = 'index.html';
                    });
                    return;
                }

                currentUser = user;
                loadUserData(user);
                loadOrders(user.uid);
            });

            // Load th√¥ng tin user
            function loadUserData(user) {
                try {
                    document.getElementById('userName').textContent = user.displayName || 'Ch∆∞a c·∫≠p nh·∫≠t';
                    document.getElementById('userEmail').textContent = user.email;

                    // Load th√¥ng tin chi ti·∫øt t·ª´ database
                    database.ref('users/' + user.uid).once('value')
                        .then((snapshot) => {
                            const userData = snapshot.val();
                            if (userData) {
                                document.getElementById('fullName').value = userData.displayName || '';
                                document.getElementById('phone').value = userData.phone || '';
                                document.getElementById('email').value = user.email;
                                document.getElementById('address').value = userData.address || '';
                                document.getElementById('city').value = userData.city || '';
                                document.getElementById('district').value = userData.district || '';
                            }
                        })
                        .catch((error) => {
                            console.error('L·ªói khi load th√¥ng tin user:', error);
                            Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ng∆∞·ªùi d√πng', 'error');
                        });
                } catch (error) {
                    console.error('L·ªói khi x·ª≠ l√Ω th√¥ng tin user:', error);
                    Swal.fire('L·ªói', 'C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω th√¥ng tin', 'error');
                }
            }

            // Load l·ªãch s·ª≠ ƒë·∫∑t h√†ng
            function loadOrders(userId) {
                const orderList = document.getElementById('orderList');
                
                try {
                    database.ref('orders').orderByChild('userId').equalTo(userId).on('value', (snapshot) => {
                        const orders = snapshot.val();
                        orderList.innerHTML = '';

                        if (!orders) {
                            orderList.innerHTML = '<p>B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</p>';
                            return;
                        }

                        Object.entries(orders).forEach(([orderId, order]) => {
                            if (!order || !order.items) return;

                            const statusClass = {
                                'pending': 'status-pending',
                                'processing': 'status-processing',
                                'completed': 'status-completed',
                                'cancelled': 'status-cancelled'
                            }[order.status] || 'status-pending';

                            const statusText = {
                                'pending': 'Ch·ªù x√°c nh·∫≠n',
                                'processing': 'ƒêang x·ª≠ l√Ω',
                                'completed': 'Ho√†n th√†nh',
                                'cancelled': 'ƒê√£ h·ªßy'
                            }[order.status] || 'Ch·ªù x√°c nh·∫≠n';

                            const orderDate = new Date(order.createdAt).toLocaleString();

                            let orderItems = '';
                            order.items.forEach(item => {
                                if (!item) return;
                                orderItems += `
                                    <div class="order-item">
                                        <img src="${item.image || 'picture/logo.jpg'}" alt="${item.name || 'S·∫£n ph·∫©m'}" class="item-image">
                                        <div class="item-details">
                                            <h4 class="item-name">${item.name || 'S·∫£n ph·∫©m kh√¥ng x√°c ƒë·ªãnh'}</h4>
                                            <p class="item-price">${(item.price || 0).toLocaleString()}ƒë x ${item.quantity || 1}</p>
                                        </div>
                                    </div>
                                `;
                            });

                            orderList.innerHTML += `
                                <div class="order-card">
                                    <div class="order-header">
                                        <span class="order-number">ƒê∆°n h√†ng #${orderId}</span>
                                        <span class="order-status ${statusClass}">${statusText}</span>
                                    </div>
                                    <div class="order-items">
                                        ${orderItems}
                                    </div>
                                    <div class="order-footer">
                                        <span class="order-total">T·ªïng ti·ªÅn: ${(order.total || 0).toLocaleString()}ƒë</span>
                                        <div class="order-actions">
                                            <button class="btn btn-outline" onclick="viewOrderDetail('${orderId}')">Chi ti·∫øt</button>
                                            ${order.status === 'pending' ? `
                                                <button class="btn btn-outline" onclick="cancelOrder('${orderId}')">H·ªßy ƒë∆°n</button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    }, (error) => {
                        console.error('L·ªói khi load ƒë∆°n h√†ng:', error);
                        Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ ƒë∆°n h√†ng', 'error');
                    });
                } catch (error) {
                    console.error('L·ªói khi x·ª≠ l√Ω ƒë∆°n h√†ng:', error);
                    Swal.fire('L·ªói', 'C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω ƒë∆°n h√†ng', 'error');
                }
            }

            // C·∫≠p nh·∫≠t th√¥ng tin c√° nh√¢n
            function updateProfile(event) {
                event.preventDefault();
                if (!currentUser) return;

                const fullName = document.getElementById('fullName').value.trim();
                const phone = document.getElementById('phone').value.trim();

                if (!fullName) {
                    Swal.fire('L·ªói', 'Vui l√≤ng nh·∫≠p h·ªç t√™n', 'error');
                    return;
                }

                if (!phone) {
                    Swal.fire('L·ªói', 'Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i', 'error');
                    return;
                }

                // Validate phone number
                const phoneRegex = /^[0-9]{10,11}$/;
                if (!phoneRegex.test(phone)) {
                    Swal.fire('L·ªói', 'S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá', 'error');
                    return;
                }

                const userData = {
                    displayName: fullName,
                    phone: phone
                };

                // Show loading
                Swal.fire({
                    title: 'ƒêang c·∫≠p nh·∫≠t...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                database.ref('users/' + currentUser.uid).update(userData)
                    .then(() => {
                        // Update display name in auth
                        return currentUser.updateProfile({
                            displayName: fullName
                        });
                    })
                    .then(() => {
                        Swal.fire('Th√†nh c√¥ng', 'Th√¥ng tin ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t', 'success');
                        loadUserData(currentUser);
                    })
                    .catch((error) => {
                        console.error('L·ªói khi c·∫≠p nh·∫≠t th√¥ng tin:', error);
                        Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t th√¥ng tin', 'error');
                    });
            }

            // C·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ
            function updateAddress(event) {
                event.preventDefault();
                if (!currentUser) return;

                const address = document.getElementById('address').value.trim();
                const city = document.getElementById('city').value.trim();
                const district = document.getElementById('district').value.trim();

                if (!address || !city || !district) {
                    Swal.fire('L·ªói', 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin ƒë·ªãa ch·ªâ', 'error');
                    return;
                }

                const addressData = {
                    address: address,
                    city: city,
                    district: district
                };

                // Show loading
                Swal.fire({
                    title: 'ƒêang c·∫≠p nh·∫≠t...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                database.ref('users/' + currentUser.uid).update(addressData)
                    .then(() => {
                        Swal.fire('Th√†nh c√¥ng', 'ƒê·ªãa ch·ªâ ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t', 'success');
                    })
                    .catch((error) => {
                        console.error('L·ªói khi c·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ:', error);
                        Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ', 'error');
                    });
            }

            // ƒê·ªïi m·∫≠t kh·∫©u
            function updatePassword(event) {
                event.preventDefault();
                if (!currentUser) return;

                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                if (!currentPassword || !newPassword || !confirmPassword) {
                    Swal.fire('L·ªói', 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin', 'error');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    Swal.fire('L·ªói', 'M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp', 'error');
                    return;
                }

                if (newPassword.length < 6) {
                    Swal.fire('L·ªói', 'M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±', 'error');
                    return;
                }

                // Show loading
                Swal.fire({
                    title: 'ƒêang x·ª≠ l√Ω...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Reauthenticate user
                const credential = firebase.auth.EmailAuthProvider.credential(
                    currentUser.email,
                    currentPassword
                );

                currentUser.reauthenticateWithCredential(credential)
                    .then(() => {
                        return currentUser.updatePassword(newPassword);
                    })
                    .then(() => {
                        Swal.fire('Th√†nh c√¥ng', 'M·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t', 'success');
                        document.getElementById('passwordForm').reset();
                    })
                    .catch((error) => {
                        console.error('L·ªói khi ƒë·ªïi m·∫≠t kh·∫©u:', error);
                        if (error.code === 'auth/wrong-password') {
                            Swal.fire('L·ªói', 'M·∫≠t kh·∫©u hi·ªán t·∫°i kh√¥ng ƒë√∫ng', 'error');
                        } else {
                            Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t m·∫≠t kh·∫©u', 'error');
                        }
                    });
            }

            // Xem chi ti·∫øt ƒë∆°n h√†ng
            function viewOrderDetail(orderId) {
                if (!orderId) return;

                // Show loading
                Swal.fire({
                    title: 'ƒêang t·∫£i...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                database.ref('orders/' + orderId).once('value')
                    .then((snapshot) => {
                        const order = snapshot.val();
                        if (!order) {
                            throw new Error('Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng');
                        }

                        const orderDate = new Date(order.createdAt).toLocaleString();
                        const statusText = {
                            'pending': 'Ch·ªù x√°c nh·∫≠n',
                            'processing': 'ƒêang x·ª≠ l√Ω',
                            'completed': 'Ho√†n th√†nh',
                            'cancelled': 'ƒê√£ h·ªßy'
                        }[order.status] || 'Ch·ªù x√°c nh·∫≠n';

                        let itemsHtml = '';
                        if (order.items && order.items.length > 0) {
                            itemsHtml = order.items.map(item => `
                                <div style="margin-bottom: 10px;">
                                    <p><strong>${item.name}</strong></p>
                                    <p>S·ªë l∆∞·ª£ng: ${item.quantity}</p>
                                    <p>Gi√°: ${item.price.toLocaleString()}ƒë</p>
                                </div>
                            `).join('');
                        }

                        Swal.fire({
                            title: `Chi ti·∫øt ƒë∆°n h√†ng #${orderId}`,
                            html: `
                                <div style="text-align: left;">
                                    <p><strong>Ng√†y ƒë·∫∑t:</strong> ${orderDate}</p>
                                    <p><strong>Tr·∫°ng th√°i:</strong> ${statusText}</p>
                                    <p><strong>ƒê·ªãa ch·ªâ giao h√†ng:</strong> ${order.shippingAddress || 'Ch∆∞a c·∫≠p nh·∫≠t'}</p>
                                    <p><strong>T·ªïng ti·ªÅn:</strong> ${(order.total || 0).toLocaleString()}ƒë</p>
                                    <hr>
                                    <h4>S·∫£n ph·∫©m:</h4>
                                    ${itemsHtml}
                                </div>
                            `,
                            width: '600px'
                        });
                    })
                    .catch((error) => {
                        console.error('L·ªói khi xem chi ti·∫øt ƒë∆°n h√†ng:', error);
                        Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ƒë∆°n h√†ng', 'error');
                    });
            }

            // H·ªßy ƒë∆°n h√†ng
            function cancelOrder(orderId) {
                if (!orderId) return;

                Swal.fire({
                    title: 'X√°c nh·∫≠n h·ªßy ƒë∆°n',
                    text: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë∆°n h√†ng n√†y?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'H·ªßy ƒë∆°n',
                    cancelButtonText: 'Kh√¥ng'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Show loading
                        Swal.fire({
                            title: 'ƒêang x·ª≠ l√Ω...',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });

                        database.ref('orders/' + orderId).update({
                            status: 'cancelled',
                            cancelledAt: firebase.database.ServerValue.TIMESTAMP
                        }).then(() => {
                            Swal.fire('Th√†nh c√¥ng', 'ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c h·ªßy', 'success');
                        }).catch((error) => {
                            console.error('L·ªói khi h·ªßy ƒë∆°n h√†ng:', error);
                            Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ h·ªßy ƒë∆°n h√†ng', 'error');
                        });
                    }
                });
            }

            // Hi·ªÉn th·ªã section
            function showSection(sectionId) {
                if (!sectionId) return;

                // ·∫®n t·∫•t c·∫£ c√°c section
                document.querySelectorAll('.content-section').forEach(section => {
                    section.style.display = 'none';
                });

                // Hi·ªÉn th·ªã section ƒë∆∞·ª£c ch·ªçn
                const selectedSection = document.getElementById(sectionId + 'Section');
                if (selectedSection) {
                    selectedSection.style.display = 'block';
                }

                // C·∫≠p nh·∫≠t active state cho menu
                document.querySelectorAll('.sidebar-menu a').forEach(link => {
                    link.classList.remove('active');
                });
                event.currentTarget.classList.add('active');
            }

            // ƒêƒÉng xu·∫•t
            function logout() {
                Swal.fire({
                    title: 'X√°c nh·∫≠n ƒëƒÉng xu·∫•t',
                    text: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'ƒêƒÉng xu·∫•t',
                    cancelButtonText: 'H·ªßy'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Show loading
                        Swal.fire({
                            title: 'ƒêang ƒëƒÉng xu·∫•t...',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });

                        auth.signOut().then(() => {
                            window.location.href = 'index.html';
                        }).catch((error) => {
                            console.error('L·ªói khi ƒëƒÉng xu·∫•t:', error);
                            Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ ƒëƒÉng xu·∫•t', 'error');
                        });
                    }
                });
            }

            // X·ª≠ l√Ω l·ªói chung
            window.onerror = function(msg, url, lineNo, columnNo, error) {
                console.error('L·ªói:', msg, 'URL:', url, 'Line:', lineNo, 'Column:', columnNo, 'Error:', error);
                return false;
            };
        </script>
    </body>
</html> 